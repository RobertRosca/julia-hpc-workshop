
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Optimizing “Serial” Performance &#8212; Julia for HPC&lt;br&gt;EuXFEL Workshop</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="SIMD" href="2-simd.html" />
    <link rel="prev" title="Package Management" href="../1-basics/6-pkg-management.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Julia for HPC<br>EuXFEL Workshop</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Jupyter for HPC - EuXFEL Trial Run
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 1 - Basics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/0-syntax.html">
   Syntax
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/1-types-dispatch.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/2-duck-typing-benchmarking.html">
   Duck Typing, Interfaces, and Benchmarkin
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/3-specialization.html">
   Code Specialization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/4-generic-programming.html">
   Generic programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/5-workflow.html">
   Development Workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/6-pkg-management.html">
   Package Management
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 2 - Serial
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Optimizing “Serial” Performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-simd.html">
   SIMD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3-interop-microbenchmark.html">
   Programming language interoperability (Interop)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4-linalg-pefrormance.html">
   Performance Considerations for Linear Algebra
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/robertrosca/julia-hpc-workshop/master?urlpath=tree/sessions/2-serial/1-optimizing-serial-performance.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/robertrosca/julia-hpc-workshop"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/robertrosca/julia-hpc-workshop/issues/new?title=Issue%20on%20page%20%2Fsessions/2-serial/1-optimizing-serial-performance.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/sessions/2-serial/1-optimizing-serial-performance.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Optimizing “Serial” Performance
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-unnecessary-allocations">
     Avoid Unnecessary Allocations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1-element-wise-operations">
       Example 1: Element-Wise Operations
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-write-explicit-loops">
         Fix 1: Write explicit loops
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-broadcasting-aka-more-dots">
         Fix 2: Broadcasting (aka “More Dots”)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-immutable-datatypes-if-possible">
         Fix 3: Immutable Datatypes (if possible)
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-linear-algebra">
       Example 2: Linear Algebra
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-preallocate-and-reuse-memory-in-place-matrix-multipy">
         Fix: Preallocate and reuse memory + in-place matrix-multipy
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-3-array-slicing">
       Example 3: Array slicing
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-views">
         Fix: Views
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-4-vectorized-style">
       Example 4: Vectorized Style
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-call-directly-on-variable">
         Fix: Call Directly on Variable
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-generators-and-laziness">
         Fix: Generators and Laziness
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-type-instabilities">
     Avoid Type Instabilities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-global-scope">
       Example: Global scope
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-work-in-local-scope">
         Fix 1: Work in local scope
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-make-globals-constant">
         Fix 2: Make globals
         <code class="docutils literal notranslate">
          <span class="pre">
           const
          </span>
         </code>
         ant
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-write-self-contained-functions">
         Fix 3: Write self-contained functions
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-multiple-returns">
       Example: Multiple Returns
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-hint-return-type">
         Fix: Hint Return Type
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-abstract-field-types">
     Avoid Abstract Field Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1">
       Example 1
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-concrete-typing">
         Fix 1: Concrete typing
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-type-parameters">
         Fix 2: Type parameters
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-cooler-diagonal-matrix">
       Example 2 - Cooler Diagonal Matrix
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-untyped-containers">
     Avoid Untyped Containers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example">
       Example
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-changing-variable-types">
     Avoid Changing Variable Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Example
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-initialize-with-correct-type">
         Fix 1: Initialize with correct type
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion">
         Fix 2: Specify types (to get errors or to heal the problem by conversion)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-special-case-first-iteration">
         Fix 3: Special-case first iteration
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#isolate-unavoidable-type-instabilities">
     Isolate Unavoidable Type Instabilities
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-arrays-in-column-major-order">
     Access Arrays in Column-Major Order
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-annotations">
     Performance Annotations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inbounds">
       <code class="docutils literal notranslate">
        <span class="pre">
         @inbounds
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simd">
       <code class="docutils literal notranslate">
        <span class="pre">
         @simd
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fastmath">
       <code class="docutils literal notranslate">
        <span class="pre">
         @fastmath
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cpu-operations-vary-in-cost">
     CPU operations vary in cost
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-division-vs-multiplication">
       Example: Division vs multiplication
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysis-tools">
     Analysis Tools
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#traceur-jl">
       Traceur.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#jet-jl">
       JET.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cthulhu-jl">
       Cthulhu.jl
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Optimizing “Serial” Performance</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Optimizing “Serial” Performance
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-unnecessary-allocations">
     Avoid Unnecessary Allocations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1-element-wise-operations">
       Example 1: Element-Wise Operations
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-write-explicit-loops">
         Fix 1: Write explicit loops
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-broadcasting-aka-more-dots">
         Fix 2: Broadcasting (aka “More Dots”)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-immutable-datatypes-if-possible">
         Fix 3: Immutable Datatypes (if possible)
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-linear-algebra">
       Example 2: Linear Algebra
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-preallocate-and-reuse-memory-in-place-matrix-multipy">
         Fix: Preallocate and reuse memory + in-place matrix-multipy
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-3-array-slicing">
       Example 3: Array slicing
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-views">
         Fix: Views
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-4-vectorized-style">
       Example 4: Vectorized Style
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-call-directly-on-variable">
         Fix: Call Directly on Variable
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-generators-and-laziness">
         Fix: Generators and Laziness
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-type-instabilities">
     Avoid Type Instabilities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-global-scope">
       Example: Global scope
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-work-in-local-scope">
         Fix 1: Work in local scope
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-make-globals-constant">
         Fix 2: Make globals
         <code class="docutils literal notranslate">
          <span class="pre">
           const
          </span>
         </code>
         ant
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-write-self-contained-functions">
         Fix 3: Write self-contained functions
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-multiple-returns">
       Example: Multiple Returns
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-hint-return-type">
         Fix: Hint Return Type
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-abstract-field-types">
     Avoid Abstract Field Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1">
       Example 1
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-concrete-typing">
         Fix 1: Concrete typing
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-type-parameters">
         Fix 2: Type parameters
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-cooler-diagonal-matrix">
       Example 2 - Cooler Diagonal Matrix
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-untyped-containers">
     Avoid Untyped Containers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example">
       Example
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-changing-variable-types">
     Avoid Changing Variable Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Example
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-initialize-with-correct-type">
         Fix 1: Initialize with correct type
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion">
         Fix 2: Specify types (to get errors or to heal the problem by conversion)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-special-case-first-iteration">
         Fix 3: Special-case first iteration
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#isolate-unavoidable-type-instabilities">
     Isolate Unavoidable Type Instabilities
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-arrays-in-column-major-order">
     Access Arrays in Column-Major Order
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-annotations">
     Performance Annotations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inbounds">
       <code class="docutils literal notranslate">
        <span class="pre">
         @inbounds
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simd">
       <code class="docutils literal notranslate">
        <span class="pre">
         @simd
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fastmath">
       <code class="docutils literal notranslate">
        <span class="pre">
         @fastmath
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cpu-operations-vary-in-cost">
     CPU operations vary in cost
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-division-vs-multiplication">
       Example: Division vs multiplication
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysis-tools">
     Analysis Tools
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#traceur-jl">
       Traceur.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#jet-jl">
       JET.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cthulhu-jl">
       Cthulhu.jl
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="optimizing-serial-performance">
<h1>Optimizing “Serial” Performance<a class="headerlink" href="#optimizing-serial-performance" title="Permalink to this headline">#</a></h1>
<p>At the heart of fast parallel code must be fast serial code. Parallelism can make a good serial code faster. But it can also make a bad code even worse. One can write terribly slow code in any language, including Julia. In this notebook we want to understand what makes Julia code slow and how to detect and avoid common pitfalls. This will lead to multiple concrete performance tips that will help you speed up your Julia code and to write more efficient code in the first place.</p>
<p>By far the most common reasons for slow Julia code are</p>
<ul class="simple">
<li><p><strong>too many (unnecessary) allocations</strong></p></li>
<li><p><strong>break-down of type inference</strong> (e.g. type instabilities)</p></li>
</ul>
<section id="avoid-unnecessary-allocations">
<h2>Avoid Unnecessary Allocations<a class="headerlink" href="#avoid-unnecessary-allocations" title="Permalink to this headline">#</a></h2>
<p>Dynamic heap allocations are costly compared to floating point operations. Avoid them, in particular in “hot” loops, because they may trigger garbage collection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.4</span><span class="p">;</span>
<span class="nd">@btime</span><span class="w"> </span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<section id="example-1-element-wise-operations">
<h3>Example 1: Element-Wise Operations<a class="headerlink" href="#example-1-element-wise-operations" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10_000</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Huge number of allocations!</p></li>
<li><p>Bad sign that they scale with the number of iterations!</p></li>
</ul>
<section id="fix-1-write-explicit-loops">
<h4>Fix 1: Write explicit loops<a class="headerlink" href="#fix-1-write-explicit-loops" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">            </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-2-broadcasting-aka-more-dots">
<h4>Fix 2: Broadcasting (aka “More Dots”)<a class="headerlink" href="#fix-2-broadcasting-aka-more-dots" title="Permalink to this headline">#</a></h4>
<p>(Recommendation: Old but great <a class="reference external" href="https://julialang.org/blog/2017/01/moredots">blog post</a> by Steven G. Johnson (<a class="reference external" href="https://github.com/JuliaLang/www.julialang.org/blob/master/blog/_posts/moredots/More-Dots.ipynb">related notebook</a>))</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="c"># or put @. in front</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-3-immutable-datatypes-if-possible">
<h4>Fix 3: Immutable Datatypes (if possible)<a class="headerlink" href="#fix-3-immutable-datatypes-if-possible" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">StaticArrays</span>

<span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@SVector</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<p>No dynamic heap allocations at all!</p>
</section>
</section>
<section id="example-2-linear-algebra">
<h3>Example 2: Linear Algebra<a class="headerlink" href="#example-2-linear-algebra" title="Permalink to this headline">#</a></h3>
<details>
<summary>Spoilers</summary>
There's a good chance that there will not be a large performance difference between these.
<p>That’s likely because this is an intense enough benchmark that you may begin to run into CPU throttling with a large number of samples, and the slowdown caused by that throttling dominates the average time far more than the improvement of the code.</p>
<p>By lowering the sample size to on the order of dozens (or less) you can see that the first function (on my PC, this will vary) takes roughly 160ms, and the second takes 11ms, an order of magnitude faster.</p>
<p>A slight hint of this may be seen on the benchmark histogram: both have a small clump of results on the far left ast very low times, and the ‘range’ section of the benchmark has a much lower value for the imporved function.</p>
</details><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">1_000</span>
<span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">A</span>
<span class="k">end</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-preallocate-and-reuse-memory-in-place-matrix-multipy">
<h4>Fix: Preallocate and reuse memory + in-place matrix-multipy<a class="headerlink" href="#fix-preallocate-and-reuse-memory-in-place-matrix-multipy" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">LinearAlgebra</span>

<span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="c"># preallocate</span>
<span class="w">    </span><span class="c"># C = Array{Float64, 2}(undef, 100, 100)  # A tad faster</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
<span class="w">        </span><span class="n">mul!</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="c"># reuse / in-place matmul</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">A</span>
<span class="k">end</span>

<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-3-array-slicing">
<h3>Example 3: Array slicing<a class="headerlink" href="#example-3-array-slicing" title="Permalink to this headline">#</a></h3>
<p>By default, array-slicing creates copies!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>

<span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">X</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-views">
<h4>Fix: Views<a class="headerlink" href="#fix-views" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@views</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="c"># expands to</span>
<span class="c"># f(Y) = view(Y, 1:3, 1) .+ view(Y, 1:3, 2) .+ view(Y, 1:3, 3)</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">X</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>(Note that <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#Copying-data-is-not-always-bad">copying data isn’t always bad</a>)</p>
</section>
</section>
<section id="example-4-vectorized-style">
<h3>Example 4: Vectorized Style<a class="headerlink" href="#example-4-vectorized-style" title="Permalink to this headline">#</a></h3>
<p>Let’s say we want the sum of the sin of the numbers 1 to 10:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">sin</span><span class="o">.</span><span class="p">([</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">]))</span><span class="w">  </span><span class="c"># Dot for broadcast notation</span>
<span class="c"># sum(map(sin, [k for k in 1:10]));  # Equivalent to this</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-call-directly-on-variable">
<h4>Fix: Call Directly on Variable<a class="headerlink" href="#fix-call-directly-on-variable" title="Permalink to this headline">#</a></h4>
<p>No need to call sin after the list is generated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">([</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-generators-and-laziness">
<h4>Fix: Generators and Laziness<a class="headerlink" href="#fix-generators-and-laziness" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c"># generator</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c"># two-argument version of sum</span>
</pre></div>
</div>
</div>
</div>
<p>How about we do our own sum?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">])</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterators</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">])</span><span class="w">  </span><span class="c"># Lazy map, on an vector</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterators</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="c"># Lazy map, on a generator</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="c"># Only generator, already lazy</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>This highlights the point from the first session: <strong>user code is as performant as any other code</strong></p>
<p>Try doing this in Numpy and it’s always orders of magnitude slower than the Julia version, with the user-implemented sum being twice as slow as the built-in Numpy sum.</p>
</section>
</section>
</section>
<section id="avoid-type-instabilities">
<h2>Avoid Type Instabilities<a class="headerlink" href="#avoid-type-instabilities" title="Permalink to this headline">#</a></h2>
<p><strong>Type stability</strong>: A function <code class="docutils literal notranslate"><span class="pre">f</span></code> is type stable if for a given set of input argument types the return type is always the same.</p>
<p>In particular, it means that the type of the output of <code class="docutils literal notranslate"><span class="pre">f</span></code> cannot vary depending on the <strong>values</strong> of the inputs.</p>
<p><strong>Type instability</strong>: The return type of a function <code class="docutils literal notranslate"><span class="pre">f</span></code> is not predictable just from the type of the input arguments alone.</p>
<p>Instructive example: <code class="docutils literal notranslate"><span class="pre">f(x)</span> <span class="pre">=</span> <span class="pre">rand()</span> <span class="pre">&gt;</span> <span class="pre">0.5</span> <span class="pre">?</span> <span class="pre">1.23</span> <span class="pre">:</span> <span class="pre">&quot;string&quot;</span></code></p>
<section id="example-global-scope">
<h3>Example: Global scope<a class="headerlink" href="#example-global-scope" title="Permalink to this headline">#</a></h3>
<p>A typical cause of type instability are global variables.</p>
<p>From a compiler perspective, variables defined in global scope <strong>can change their value and even their type(!) any time</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-1-work-in-local-scope">
<h4>Fix 1: Work in local scope<a class="headerlink" href="#fix-1-work-in-local-scope" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="w">    </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="k">end</span>

<span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This is fast.</p>
<p>In fact, it’s not just fast, but <strong>as fast as it can be</strong>! Julia has figured out the result of the calculation at compile-time and returns just the literal, i.e. <code class="docutils literal notranslate"><span class="pre">local_scope()</span> <span class="pre">=</span> <span class="pre">7</span></code>.</p>
</section>
<section id="fix-2-make-globals-constant">
<h4>Fix 2: Make globals <code class="docutils literal notranslate"><span class="pre">const</span></code>ant<a class="headerlink" href="#fix-2-make-globals-constant" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="k">const</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span>

<span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-3-write-self-contained-functions">
<h4>Fix 3: Write self-contained functions<a class="headerlink" href="#fix-3-write-self-contained-functions" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Write functions not scripts!</strong></p>
</section>
</section>
<section id="example-multiple-returns">
<h3>Example: Multiple Returns<a class="headerlink" href="#example-multiple-returns" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">flag</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Int64</span><span class="p">},</span><span class="w"> </span><span class="n">round</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-hint-return-type">
<h4>Fix: Hint Return Type<a class="headerlink" href="#fix-hint-return-type" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">flag</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>NB: Really, a <code class="docutils literal notranslate"><span class="pre">Union</span></code> return with a few types in it is not that bad as Julia typically handles this situation via union splitting. However it can make the compilers job harder.</p>
</section>
</section>
</section>
<section id="avoid-abstract-field-types">
<h2>Avoid Abstract Field Types<a class="headerlink" href="#avoid-abstract-field-types" title="Permalink to this headline">#</a></h2>
<p>A common reason for type inference to break are not-concretely typed fields in <code class="docutils literal notranslate"><span class="pre">struct</span></code>s</p>
<section id="example-1">
<h3>Example 1<a class="headerlink" href="#example-1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MyType</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">Number</span>
<span class="w">    </span><span class="n">y</span><span class="o">::</span><span class="kt">String</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="o">::</span><span class="kt">MyType</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyType</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>“Type stability”</strong>: A function <code class="docutils literal notranslate"><span class="pre">f</span></code> is type stable if for a given set of input argument types the return type is always the same and <em>concrete</em>.</p>
<section id="fix-1-concrete-typing">
<h4>Fix 1: Concrete typing<a class="headerlink" href="#fix-1-concrete-typing" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MyTypeConcrete</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">Float64</span>
<span class="w">    </span><span class="n">y</span><span class="o">::</span><span class="kt">String</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">MyTypeConcrete</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyTypeConcrete</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">b</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-2-type-parameters">
<h4>Fix 2: Type parameters<a class="headerlink" href="#fix-2-type-parameters" title="Permalink to this headline">#</a></h4>
<p>But what if I want to accept any kind of, say, <code class="docutils literal notranslate"><span class="pre">Number</span></code> and <code class="docutils literal notranslate"><span class="pre">AbstractString</span></code> for our type?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MyTypeParametric</span><span class="p">{</span><span class="kt">A</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Number</span><span class="p">,</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractString</span><span class="p">}</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">A</span>
<span class="w">    </span><span class="n">y</span><span class="o">::</span><span class="kt">B</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="n">c</span><span class="o">::</span><span class="kt">MyTypeParametric</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyTypeParametric</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>From the type alone the compiler knows what the structure contains and can produce optimal code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyTypeParametric</span><span class="p">(</span><span class="kt">Float32</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span><span class="w"> </span><span class="kt">SubString</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-2-cooler-diagonal-matrix">
<h3>Example 2 - Cooler Diagonal Matrix<a class="headerlink" href="#example-2-cooler-diagonal-matrix" title="Permalink to this headline">#</a></h3>
<p>Yesterday we created a diagonal matrix which could take in a <code class="docutils literal notranslate"><span class="pre">Vector</span></code> and create an object that acted like a diagonal matrix.</p>
<p>By replacing the <code class="docutils literal notranslate"><span class="pre">Vector</span></code> with an <code class="docutils literal notranslate"><span class="pre">AbstractVector</span></code>, we made this work with anything vector-like, like ranges.</p>
<p>However, this ended up being slower than the original implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">DiagonalMatrix</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="mi">2</span><span class="p">}</span>
<span class="w">    </span><span class="n">diag</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">),</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.:+</span><span class="p">(</span><span class="n">Da</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">Db</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">Da</span><span class="o">.</span><span class="n">diag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Db</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">CoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span>
<span class="w">    </span><span class="n">diag</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">),</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.:+</span><span class="p">(</span><span class="n">Da</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">Db</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="n">Da</span><span class="o">.</span><span class="n">diag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Db</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span>

<span class="n">DM_cool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DM</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DM_cool</span>
</pre></div>
</div>
</div>
</div>
<p>This is the same as the previous problem: an <code class="docutils literal notranslate"><span class="pre">AbstractVector{Int64}</span></code> is not a concrete type, it means:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">subtypes</span><span class="p">(</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">Int64</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>So really it’s a union of all of the above types, not a single type!</p>
<p>We can avoid this with some slightly fancier code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="kt">U</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">}</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span>
<span class="w">    </span><span class="n">diag</span><span class="o">::</span><span class="kt">U</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">),</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.:+</span><span class="p">(</span><span class="n">Da</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">Db</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="n">Da</span><span class="o">.</span><span class="n">diag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Db</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="kt">UnitRange</span><span class="p">{</span><span class="kt">Int64</span><span class="p">}}(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="n">diag</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">eltype</span><span class="p">(</span><span class="kt">diag</span><span class="p">),</span><span class="w"> </span><span class="kt">typeof</span><span class="p">(</span><span class="kt">diag</span><span class="p">)}(</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="kt">UnitRange</span><span class="p">{</span><span class="kt">Int64</span><span class="p">}}(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span>

<span class="n">DM_cool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="p">;</span>

<span class="n">DM_mcool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span>

<span class="n">DM_cool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">)</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="p">;</span>

<span class="n">DM_mcool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">)</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">DM_mcool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DM_mcool</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="avoid-untyped-containers">
<h2>Avoid Untyped Containers<a class="headerlink" href="#avoid-untyped-containers" title="Permalink to this headline">#</a></h2>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">([])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Int</span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="avoid-changing-variable-types">
<h2>Avoid Changing Variable Types<a class="headerlink" href="#avoid-changing-variable-types" title="Permalink to this headline">#</a></h2>
<p>Variables in a function should not change type.</p>
<section id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<p>(On a side note: since the type can only vary between <code class="docutils literal notranslate"><span class="pre">Float64</span></code> and <code class="docutils literal notranslate"><span class="pre">Int64</span></code>, Julia can still produce reasonable code by <em>union splitting</em>. I recommend reading <a class="reference external" href="https://julialang.org/blog/2018/08/union-splitting">this blog post</a> by Tim Holy.)</p>
<section id="fix-1-initialize-with-correct-type">
<h4>Fix 1: Initialize with correct type<a class="headerlink" href="#fix-1-initialize-with-correct-type" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion">
<h4>Fix 2: Specify types (to get errors or to heal the problem by conversion)<a class="headerlink" href="#fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c"># implicit conversion</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-3-special-case-first-iteration">
<h4>Fix 3: Special-case first iteration<a class="headerlink" href="#fix-3-special-case-first-iteration" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="isolate-unavoidable-type-instabilities">
<h2>Isolate Unavoidable Type Instabilities<a class="headerlink" href="#isolate-unavoidable-type-instabilities" title="Permalink to this headline">#</a></h2>
<p>Type instabilities can occur very naturally, for example when reading unknown user files or user input. Hence, not every instability can be avoided.</p>
<p>If that’s the case, isolate your expensive computation from the instability by putting it in a separate <em>kernel function</em> (also known as introducing a <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#kernel-functions">function barrier</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Union</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="kt">Float64</span><span class="p">,</span><span class="kt">String</span><span class="p">}[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">3.2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_computation_kernel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">_computation_kernel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">c</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">_computation_kernel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the computational kernel function is fully type inferred.</p>
</section>
<section id="access-arrays-in-column-major-order">
<h2>Access Arrays in Column-Major Order<a class="headerlink" href="#access-arrays-in-column-major-order" title="Permalink to this headline">#</a></h2>
<img src="../../static/column-major-2D.png" width=800px>
<p>Excellent page on this topic: <a class="reference external" href="https://book.sciml.ai/notes/02-Optimizing_Serial_Code/">https://book.sciml.ai/notes/02-Optimizing_Serial_Code/</a></p>
<p><strong>Fastest varying loop index goes first.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">fcol!</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">nothing</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">frow!</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">nothing</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">fcol!</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">frow!</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Lots of cache misses for <code class="docutils literal notranslate"><span class="pre">frow</span></code>!</p>
</section>
<section id="performance-annotations">
<h2>Performance Annotations<a class="headerlink" href="#performance-annotations" title="Permalink to this headline">#</a></h2>
<section id="inbounds">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;inbounds</span></code><a class="headerlink" href="#inbounds" title="Permalink to this headline">#</a></h3>
<p>Disables bounds checks. (Julia may segfault if you use it wrongly!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
<span class="w">            </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f_inbounds</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
<span class="w">            </span><span class="nd">@inbounds</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f_inbounds</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="simd">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;simd</span></code><a class="headerlink" href="#simd" title="Permalink to this headline">#</a></h3>
<p>Enables SIMD optimizations that are potentially <em>unsafe</em>. Julia may execute loop iterations in arbitrary or overlapping order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f_simd</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="nd">@simd</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f_simd</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>(For integer input both versions have the same speed because integer addition is associative, in contrast to floating point arithmetics.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">CpuId</span>
<span class="n">cpuinfo</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">f_simd</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fastmath">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;fastmath</span></code><a class="headerlink" href="#fastmath" title="Permalink to this headline">#</a></h3>
<p>Enables lots of floating point optimizations that are potentially <em>unsafe</em>! It trades accuracy for speed, so, <a class="reference external" href="https://simonbyrne.github.io/notes/fastmath/">Beware of fast-math</a>. (See the <a class="reference external" href="https://llvm.org/docs/LangRef.html#fast-math-flags">LLVM Language Reference Manual</a> for more information on which compiler options it sets.)</p>
<p>There is <code class="docutils literal notranslate"><span class="pre">julia</span> <span class="pre">--math-mode=fast</span></code> to enable fast math globally.</p>
<p>Harmless example: <strong>FMA - Fused Multiply Add</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@noinline</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span>

<span class="nd">@code_native</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<img src="../../static/skylake_microarchitecture.png" width=700px>
<p><strong>Source:</strong> <a class="reference external" href="https://software.intel.com/sites/default/files/managed/9e/bc/64-ia-32-architectures-optimization-manual.pdf">Intel® 64 and IA-32 Architectures Optimization Reference Manual</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f_fma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>

<span class="nd">@code_native</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f_fma</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f_fastmath</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@fastmath</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span>

<span class="nd">@code_native</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f_fastmath</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Benchmarking this probably won’s show a difference due to the noise on the system dominating the tiny benefits of saving one instruction.</p>
<p>We get into this later</p>
<p>(P.S. In this specific case, <a class="reference external" href="https://github.com/SciML/MuladdMacro.jl">MuladdMacro.jl</a> is a <em>safe</em> alternative.</p>
</section>
</section>
<section id="cpu-operations-vary-in-cost">
<h2>CPU operations vary in cost<a class="headerlink" href="#cpu-operations-vary-in-cost" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="http://ithare.com/infographics-operation-costs-in-cpu-clock-cycles/">http://ithare.com/infographics-operation-costs-in-cpu-clock-cycles/</a></p>
<section id="example-division-vs-multiplication">
<h3>Example: Division vs multiplication<a class="headerlink" href="#example-division-vs-multiplication" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="mi">1000</span>
<span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="mf">1e-3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">x</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">x</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="analysis-tools">
<h2>Analysis Tools<a class="headerlink" href="#analysis-tools" title="Permalink to this headline">#</a></h2>
<section id="traceur-jl">
<h3><a class="reference external" href="https://github.com/MikeInnes/Traceur.jl">Traceur.jl</a><a class="headerlink" href="#traceur-jl" title="Permalink to this headline">#</a></h3>
<p><strong>Basic automatic performance trap checker</strong>. Essentially a codified version of the <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/">performance tips</a> in the Julia documentation.</p>
<p>Important macro: <a class="reference external" href="http://traceur.junolab.org/latest/#Traceur.&#64;trace"><code class="docutils literal notranslate"><span class="pre">&#64;trace</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Traceur</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>

<span class="nd">@trace</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="jet-jl">
<h3><a class="reference external" href="https://github.com/aviatesk/JET.jl">JET.jl</a><a class="headerlink" href="#jet-jl" title="Permalink to this headline">#</a></h3>
<p><strong>Static</strong> code analyzer. (Doesn’t execute the code!)</p>
<p>Important macros:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;report_opt</span></code>: check for potential optimization problems (<a class="reference external" href="https://aviatesk.github.io/JET.jl/stable/optanalysis/">optimization analysis</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;report_call</span></code>: check for potential (general) errors (<a class="reference external" href="https://aviatesk.github.io/JET.jl/stable/jetanalysis/">error analysis</a>)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">JET</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>

<span class="nd">@report_opt</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="c"># check for possible optimization problems</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>

<span class="nd">@report_call</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="c"># check for possible errors</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@report_opt</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@report_call</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="s">&quot;Hamburg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cthulhu-jl">
<h3><a class="reference external" href="https://github.com/JuliaDebug/Cthulhu.jl">Cthulhu.jl</a><a class="headerlink" href="#cthulhu-jl" title="Permalink to this headline">#</a></h3>
<p><strong>Interactive code explorer</strong> that let’s you navigate through a nested function call-tree and apply macros like <code class="docutils literal notranslate"><span class="pre">&#64;code_*</span></code>, or <code class="docutils literal notranslate"><span class="pre">&#64;which</span></code>, and more. For example, one can recursively apply <code class="docutils literal notranslate"><span class="pre">&#64;code_warntype</span></code> at different levels to detect the origin of a type instability. (Note though that it might take some time to master Cthulhu.)</p>
<p>Important macro: <code class="docutils literal notranslate"><span class="pre">&#64;descend</span></code> (or directly <code class="docutils literal notranslate"><span class="pre">&#64;descend_code_warntype</span></code>)</p>
<p>(Cthulhu isn’t a debugger! It has only “static” information.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Cthulhu</span>

<span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="c"># @descend A*B # doesn&#39;t work in Jupyter -&gt; use REPL</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Start with optimising serial performance, bad serial code will be bad parallel code</p></li>
<li><p><strong>Reduce number of allocations</strong></p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">&#64;btime</span></code> to check the number of allocations</p></li>
<li><p>Avoid unnecessary allocations, huge no. of them is a bad sign</p></li>
</ul>
</li>
<li><p>Avoid temporary allocations</p>
<ul>
<li><p>e.g. dot syntax for broadcasting is very useful</p></li>
<li><p>Pre-allocating result arrays can save time</p></li>
</ul>
</li>
<li><p>Slicing by default <strong>copies data</strong>, use <code class="docutils literal notranslate"><span class="pre">&#64;views</span></code> or <code class="docutils literal notranslate"><span class="pre">view(A,</span> <span class="pre">1:2,</span> <span class="pre">1)</span></code> to get a non-copy view</p></li>
<li><p>(Lazy) generators can be much faster for certain tasks</p></li>
<li><p><strong>Type instability is VERY bad</strong></p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">&#64;code_warntype</span></code> to check for type instability</p></li>
<li><p>Avoid (non-constant) globals or work only in local scope</p></li>
<li><p>Hint return types if they are <code class="docutils literal notranslate"><span class="pre">Any</span></code> or <code class="docutils literal notranslate"><span class="pre">Union</span></code> (or rewrite code to avoid this)</p></li>
<li><p><strong>Avoid abstract types</strong> in containers</p>
<ul>
<li><p>Use concrete types</p></li>
<li><p>Or, for more flexibility, parametric types</p></li>
</ul>
</li>
<li><p>Avoid <strong>untyped</strong> containers, never use <code class="docutils literal notranslate"><span class="pre">[]</span></code>, use <code class="docutils literal notranslate"><span class="pre">Int[]</span></code>/<code class="docutils literal notranslate"><span class="pre">Float[]</span></code></p></li>
<li><p>Avoid <strong>changing</strong> types, e.g. <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">1;</span> <span class="pre">x</span> <span class="pre">/</span> <span class="pre">2</span></code> converts int to float</p></li>
<li><p>Isolate instabilities with <strong>computational kernels</strong></p></li>
</ul>
</li>
<li><p>Access arrays in <strong>column major</strong> order</p></li>
<li><p>Make use of performance annotations if applicable:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;inbounds</span></code> - no bounds checking</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;simd</span></code> - fused repeated operations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;fastmath</span></code> - fused multiply add operations</p></li>
</ul>
</li>
<li><p>Remember operations have different costs, e.g. <code class="docutils literal notranslate"><span class="pre">*</span></code> is faster than <code class="docutils literal notranslate"><span class="pre">/</span></code></p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/carstenbauer/JuliaHLRS22/blob/live/Day2/1_optimizing_serial_performance.ipynb">https://github.com/carstenbauer/JuliaHLRS22/blob/live/Day2/1_optimizing_serial_performance.ipynb</a></p></li>
<li><p><a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#man-performance-abstract-container">https://docs.julialang.org/en/v1/manual/performance-tips/#man-performance-abstract-container</a></p></li>
<li><p><a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#kernel-functions">https://docs.julialang.org/en/v1/manual/performance-tips/#kernel-functions</a></p></li>
<li><p><a class="reference external" href="https://book.sciml.ai/notes/02-Optimizing_Serial_Code/">https://book.sciml.ai/notes/02-Optimizing_Serial_Code/</a></p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.8"
        },
        kernelOptions: {
            kernelName: "julia-1.8",
            path: "./sessions/2-serial"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.8'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../1-basics/6-pkg-management.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Package Management</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="2-simd.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">SIMD</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Robert Rosca<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>