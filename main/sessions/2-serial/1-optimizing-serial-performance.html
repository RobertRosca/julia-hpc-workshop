
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Optimizing “Serial” Performance &#8212; Julia for HPC&lt;br&gt;EuXFEL Workshop</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="SIMD" href="2-simd.html" />
    <link rel="prev" title="Package Management" href="../1-basics/6-pkg-management.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Julia for HPC<br>EuXFEL Workshop</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Jupyter for HPC - EuXFEL Trial Run
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 1 - Basics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/0-syntax.html">
   Syntax
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/1-types-dispatch.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/2-duck-typing-benchmarking.html">
   Duck Typing, Interfaces, and Benchmarkin
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/3-specialization.html">
   Code Specialization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/4-generic-programming.html">
   Generic programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/5-workflow.html">
   Development Workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/6-pkg-management.html">
   Package Management
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 2 - Serial
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Optimizing “Serial” Performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-simd.html">
   SIMD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3-interop-microbenchmark.html">
   Programming language interoperability (Interop)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4-linalg-pefrormance.html">
   Performance Considerations for Linear Algebra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 3 - Parallel
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../3-parallel/1-parallelism-concurrency.html">
   Parallel Computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../3-parallel/2-distributed-computing.html">
   Distributed Computing:
   <code class="docutils literal notranslate">
    <span class="pre">
     Distributed
    </span>
   </code>
   standard library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../3-parallel/3-distributed-computing-mpi.html">
   Distributed Computing: Message Passing Interface (MPI)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../3-parallel/4-multithreading.html">
   Multithreading
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/robertrosca/julia-hpc-workshop/master?urlpath=tree/sessions/2-serial/1-optimizing-serial-performance.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/robertrosca/julia-hpc-workshop"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/robertrosca/julia-hpc-workshop/issues/new?title=Issue%20on%20page%20%2Fsessions/2-serial/1-optimizing-serial-performance.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/sessions/2-serial/1-optimizing-serial-performance.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Optimizing “Serial” Performance
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-unnecessary-allocations">
     Avoid Unnecessary Allocations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1-element-wise-operations">
       Example 1: Element-Wise Operations
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-write-explicit-loops">
         Fix 1: Write explicit loops
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-broadcasting-aka-more-dots">
         Fix 2: Broadcasting (aka “More Dots”)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-immutable-datatypes-if-possible">
         Fix 3: Immutable Datatypes (if possible)
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-linear-algebra">
       Example 2: Linear Algebra
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-preallocate-and-reuse-memory-in-place-matrix-multipy">
         Fix: Preallocate and reuse memory + in-place matrix-multipy
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-3-array-slicing">
       Example 3: Array slicing
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-views">
         Fix: Views
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-4-vectorized-style">
       Example 4: Vectorized Style
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-call-directly-on-variable">
         Fix: Call Directly on Variable
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-generators-and-laziness">
         Fix: Generators and Laziness
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-type-instabilities">
     Avoid Type Instabilities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-global-scope">
       Example: Global scope
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-work-in-local-scope">
         Fix 1: Work in local scope
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-make-globals-constant">
         Fix 2: Make globals
         <code class="docutils literal notranslate">
          <span class="pre">
           const
          </span>
         </code>
         ant
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-write-self-contained-functions">
         Fix 3: Write self-contained functions
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-multiple-returns">
       Example: Multiple Returns
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-hint-return-type">
         Fix: Hint Return Type
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-abstract-field-types">
     Avoid Abstract Field Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1">
       Example 1
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-concrete-typing">
         Fix 1: Concrete typing
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-type-parameters">
         Fix 2: Type parameters
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-cooler-diagonal-matrix">
       Example 2 - Cooler Diagonal Matrix
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-untyped-containers">
     Avoid Untyped Containers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example">
       Example
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-changing-variable-types">
     Avoid Changing Variable Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Example
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-initialize-with-correct-type">
         Fix 1: Initialize with correct type
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion">
         Fix 2: Specify types (to get errors or to heal the problem by conversion)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-special-case-first-iteration">
         Fix 3: Special-case first iteration
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#isolate-unavoidable-type-instabilities">
     Isolate Unavoidable Type Instabilities
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-arrays-in-column-major-order">
     Access Arrays in Column-Major Order
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-annotations">
     Performance Annotations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inbounds">
       <code class="docutils literal notranslate">
        <span class="pre">
         @inbounds
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simd">
       <code class="docutils literal notranslate">
        <span class="pre">
         @simd
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fastmath">
       <code class="docutils literal notranslate">
        <span class="pre">
         @fastmath
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cpu-operations-vary-in-cost">
     CPU operations vary in cost
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-division-vs-multiplication">
       Example: Division vs multiplication
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysis-tools">
     Analysis Tools
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#traceur-jl">
       Traceur.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#jet-jl">
       JET.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cthulhu-jl">
       Cthulhu.jl
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Optimizing “Serial” Performance</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Optimizing “Serial” Performance
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-unnecessary-allocations">
     Avoid Unnecessary Allocations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1-element-wise-operations">
       Example 1: Element-Wise Operations
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-write-explicit-loops">
         Fix 1: Write explicit loops
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-broadcasting-aka-more-dots">
         Fix 2: Broadcasting (aka “More Dots”)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-immutable-datatypes-if-possible">
         Fix 3: Immutable Datatypes (if possible)
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-linear-algebra">
       Example 2: Linear Algebra
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-preallocate-and-reuse-memory-in-place-matrix-multipy">
         Fix: Preallocate and reuse memory + in-place matrix-multipy
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-3-array-slicing">
       Example 3: Array slicing
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-views">
         Fix: Views
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-4-vectorized-style">
       Example 4: Vectorized Style
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-call-directly-on-variable">
         Fix: Call Directly on Variable
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-generators-and-laziness">
         Fix: Generators and Laziness
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-type-instabilities">
     Avoid Type Instabilities
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-global-scope">
       Example: Global scope
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-work-in-local-scope">
         Fix 1: Work in local scope
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-make-globals-constant">
         Fix 2: Make globals
         <code class="docutils literal notranslate">
          <span class="pre">
           const
          </span>
         </code>
         ant
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-write-self-contained-functions">
         Fix 3: Write self-contained functions
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-multiple-returns">
       Example: Multiple Returns
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-hint-return-type">
         Fix: Hint Return Type
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-abstract-field-types">
     Avoid Abstract Field Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-1">
       Example 1
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-concrete-typing">
         Fix 1: Concrete typing
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-type-parameters">
         Fix 2: Type parameters
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-2-cooler-diagonal-matrix">
       Example 2 - Cooler Diagonal Matrix
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-untyped-containers">
     Avoid Untyped Containers
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example">
       Example
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-changing-variable-types">
     Avoid Changing Variable Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Example
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-1-initialize-with-correct-type">
         Fix 1: Initialize with correct type
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion">
         Fix 2: Specify types (to get errors or to heal the problem by conversion)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#fix-3-special-case-first-iteration">
         Fix 3: Special-case first iteration
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#isolate-unavoidable-type-instabilities">
     Isolate Unavoidable Type Instabilities
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-arrays-in-column-major-order">
     Access Arrays in Column-Major Order
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-annotations">
     Performance Annotations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#inbounds">
       <code class="docutils literal notranslate">
        <span class="pre">
         @inbounds
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simd">
       <code class="docutils literal notranslate">
        <span class="pre">
         @simd
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fastmath">
       <code class="docutils literal notranslate">
        <span class="pre">
         @fastmath
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cpu-operations-vary-in-cost">
     CPU operations vary in cost
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-division-vs-multiplication">
       Example: Division vs multiplication
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analysis-tools">
     Analysis Tools
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#traceur-jl">
       Traceur.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#jet-jl">
       JET.jl
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cthulhu-jl">
       Cthulhu.jl
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="optimizing-serial-performance">
<h1>Optimizing “Serial” Performance<a class="headerlink" href="#optimizing-serial-performance" title="Permalink to this headline">#</a></h1>
<p>At the heart of fast parallel code must be fast serial code. Parallelism can make a good serial code faster. But it can also make a bad code even worse. One can write terribly slow code in any language, including Julia. In this notebook we want to understand what makes Julia code slow and how to detect and avoid common pitfalls. This will lead to multiple concrete performance tips that will help you speed up your Julia code and to write more efficient code in the first place.</p>
<p>By far the most common reasons for slow Julia code are</p>
<ul class="simple">
<li><p><strong>too many (unnecessary) allocations</strong></p></li>
<li><p><strong>break-down of type inference</strong> (e.g. type instabilities)</p></li>
</ul>
<section id="avoid-unnecessary-allocations">
<h2>Avoid Unnecessary Allocations<a class="headerlink" href="#avoid-unnecessary-allocations" title="Permalink to this headline">#</a></h2>
<p>Dynamic heap allocations are costly compared to floating point operations. Avoid them, in particular in “hot” loops, because they may trigger garbage collection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.4</span><span class="p">;</span>
<span class="nd">@btime</span><span class="w"> </span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1.696 ns (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  30.512 ns (1 allocation: 64 bytes)
</pre></div>
</div>
</div>
</div>
<section id="example-1-element-wise-operations">
<h3>Example 1: Element-Wise Operations<a class="headerlink" href="#example-1-element-wise-operations" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10_000</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  752.390 μs (20001 allocations: 1.53 MiB)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Huge number of allocations!</p></li>
<li><p>Bad sign that they scale with the number of iterations!</p></li>
</ul>
<section id="fix-1-write-explicit-loops">
<h4>Fix 1: Write explicit loops<a class="headerlink" href="#fix-1-write-explicit-loops" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">            </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  327.940 μs (1 allocation: 80 bytes)
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-2-broadcasting-aka-more-dots">
<h4>Fix 2: Broadcasting (aka “More Dots”)<a class="headerlink" href="#fix-2-broadcasting-aka-more-dots" title="Permalink to this headline">#</a></h4>
<p>(Recommendation: Old but great <a class="reference external" href="https://julialang.org/blog/2017/01/moredots">blog post</a> by Steven G. Johnson (<a class="reference external" href="https://github.com/JuliaLang/www.julialang.org/blob/master/blog/_posts/moredots/More-Dots.ipynb">related notebook</a>))</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3.486 ms (100001 allocations: 7.63 MiB)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="c"># or put @. in front</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  250.670 μs (1 allocation: 80 bytes)
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-3-immutable-datatypes-if-possible">
<h4>Fix 3: Immutable Datatypes (if possible)<a class="headerlink" href="#fix-3-immutable-datatypes-if-possible" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">StaticArrays</span>

<span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@SVector</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  41.822 μs (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<p>No dynamic heap allocations at all!</p>
</section>
</section>
<section id="example-2-linear-algebra">
<h3>Example 2: Linear Algebra<a class="headerlink" href="#example-2-linear-algebra" title="Permalink to this headline">#</a></h3>
<details>
<summary>Spoilers</summary>
There's a good chance that there will not be a large performance difference between these.
<p>That’s likely because this is an intense enough benchmark that you may begin to run into CPU throttling with a large number of samples, and the slowdown caused by that throttling dominates the average time far more than the improvement of the code.</p>
<p>By lowering the sample size to on the order of dozens (or less) you can see that the first function (on my PC, this will vary) takes roughly 160ms, and the second takes 11ms, an order of magnitude faster.</p>
<p>A slight hint of this may be seen on the benchmark histogram: both have a small clump of results on the far left ast very low times, and the ‘range’ section of the benchmark has a much lower value for the imporved function.</p>
</details><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">1_000</span>
<span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">A</span>
<span class="k">end</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 68 samples with 1 evaluation.
 Range (<span class=" -Color -Color-Bold -Color-Bold-Cyan">min</span> … <span class=" -Color -Color-Magenta">max</span>):  <span class=" -Color -Color-Bold -Color-Bold-Cyan">73.275 ms</span> … <span class=" -Color -Color-Magenta"> 79.457 ms</span>  ┊ GC (min … max): 0.74% … 1.84%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Blue">median</span>):     <span class=" -Color -Color-Bold -Color-Bold-Blue">74.182 ms               </span>┊ GC (median):    1.45%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Green">mean</span> ± <span class=" -Color -Color-Green">σ</span>):   <span class=" -Color -Color-Bold -Color-Bold-Green">74.306 ms</span> ± <span class=" -Color -Color-Green">786.663 μs</span>  ┊ GC (mean ± σ):  1.32% ± 0.36%

        ▁              ▆█<span class=" -Color -Color-Blue">▃</span>█▆ <span class=" -Color -Color-Green"> </span>▁                                 
  ▄▁▄▁▁▁█▁▁▇▄▇▁▄▇▄▁▇▄▇▄██<span class=" -Color -Color-Blue">█</span>██▄<span class=" -Color -Color-Green">▇</span>█▇▁▁▁▄▁▄▇▁▇▁▁▇▁▁▁▁▁▁▄▁▄▁▁▁▄▄▁▁▁▄ ▁
  73.3 ms         Histogram: frequency by time         75.6 ms <span class=" -Color -Color-Bold">&lt;</span>

 Memory estimate: <span class=" -Color -Color-Yellow">76.49 MiB</span>, allocs estimate: <span class=" -Color -Color-Yellow">2004</span>.
</pre></div>
</div>
</div>
</div>
<section id="fix-preallocate-and-reuse-memory-in-place-matrix-multipy">
<h4>Fix: Preallocate and reuse memory + in-place matrix-multipy<a class="headerlink" href="#fix-preallocate-and-reuse-memory-in-place-matrix-multipy" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">LinearAlgebra</span>

<span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="c"># preallocate</span>
<span class="w">    </span><span class="c"># C = Array{Float64, 2}(undef, 100, 100)  # A tad faster</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
<span class="w">        </span><span class="n">mul!</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="c"># reuse / in-place matmul</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">A</span>
<span class="k">end</span>

<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 718 samples with 1 evaluation.
 Range (<span class=" -Color -Color-Bold -Color-Bold-Cyan">min</span> … <span class=" -Color -Color-Magenta">max</span>):  <span class=" -Color -Color-Bold -Color-Bold-Cyan">6.877 ms</span> … <span class=" -Color -Color-Magenta"> 14.151 ms</span>  ┊ GC (min … max): 0.00% … 0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Blue">median</span>):     <span class=" -Color -Color-Bold -Color-Bold-Blue">6.909 ms               </span>┊ GC (median):    0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Green">mean</span> ± <span class=" -Color -Color-Green">σ</span>):   <span class=" -Color -Color-Bold -Color-Bold-Green">6.963 ms</span> ± <span class=" -Color -Color-Green">338.208 μs</span>  ┊ GC (mean ± σ):  0.12% ± 1.53%

   ▆█<span class=" -Color -Color-Blue"> </span>   <span class=" -Color -Color-Green"> </span>                                                     
  ▃██<span class=" -Color -Color-Blue">▃</span>▂▄▄<span class=" -Color -Color-Green">█</span>▅▂▃▆▃▂▂▂▁▁▂▁▁▁▁▁▁▁▁▂▁▁▁▂▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▂ ▂
  6.88 ms         Histogram: frequency by time        7.61 ms <span class=" -Color -Color-Bold">&lt;</span>

 Memory estimate: <span class=" -Color -Color-Yellow">234.52 KiB</span>, allocs estimate: <span class=" -Color -Color-Yellow">6</span>.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-3-array-slicing">
<h3>Example 3: Array slicing<a class="headerlink" href="#example-3-array-slicing" title="Permalink to this headline">#</a></h3>
<p>By default, array-slicing creates copies!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>

<span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">X</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  140.757 ns (4 allocations: 320 bytes)
</pre></div>
</div>
</div>
</div>
<section id="fix-views">
<h4>Fix: Views<a class="headerlink" href="#fix-views" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@views</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Y</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>

<span class="c"># expands to</span>
<span class="c"># f(Y) = view(Y, 1:3, 1) .+ view(Y, 1:3, 2) .+ view(Y, 1:3, 3)</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">X</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  41.653 ns (1 allocation: 80 bytes)
</pre></div>
</div>
</div>
</div>
<p>(Note that <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#Copying-data-is-not-always-bad">copying data isn’t always bad</a>)</p>
</section>
</section>
<section id="example-4-vectorized-style">
<h3>Example 4: Vectorized Style<a class="headerlink" href="#example-4-vectorized-style" title="Permalink to this headline">#</a></h3>
<p>Let’s say we want the sum of the sin of the numbers 1 to 10:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">sin</span><span class="o">.</span><span class="p">([</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">]))</span><span class="w">  </span><span class="c"># Dot for broadcast notation</span>
<span class="c"># sum(map(sin, [k for k in 1:10]));  # Equivalent to this</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  174.704 ns (2 allocations: 288 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4111883712180104
</pre></div>
</div>
</div>
</div>
<section id="fix-call-directly-on-variable">
<h4>Fix: Call Directly on Variable<a class="headerlink" href="#fix-call-directly-on-variable" title="Permalink to this headline">#</a></h4>
<p>No need to call sin after the list is generated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">([</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  120.988 ns (1 allocation: 144 bytes)
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-generators-and-laziness">
<h4>Fix: Generators and Laziness<a class="headerlink" href="#fix-generators-and-laziness" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c"># generator</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  81.260 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">);</span><span class="w"> </span><span class="c"># two-argument version of sum</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  80.621 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<p>How about we do our own sum?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">])</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  174.313 ns (2 allocations: 288 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterators</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">])</span><span class="w">  </span><span class="c"># Lazy map, on an vector</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  136.249 ns (1 allocation: 144 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Iterators</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="c"># Lazy map, on a generator</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  78.933 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="c"># Only generator, already lazy</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  78.979 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<p>This highlights the point from the first session: <strong>user code is as performant as any other code</strong></p>
<p>Try doing this in Numpy and it’s always orders of magnitude slower than the Julia version, with the user-implemented sum being twice as slow as the built-in Numpy sum.</p>
</section>
</section>
</section>
<section id="avoid-type-instabilities">
<h2>Avoid Type Instabilities<a class="headerlink" href="#avoid-type-instabilities" title="Permalink to this headline">#</a></h2>
<p><strong>Type stability</strong>: A function <code class="docutils literal notranslate"><span class="pre">f</span></code> is type stable if for a given set of input argument types the return type is always the same.</p>
<p>In particular, it means that the type of the output of <code class="docutils literal notranslate"><span class="pre">f</span></code> cannot vary depending on the <strong>values</strong> of the inputs.</p>
<p><strong>Type instability</strong>: The return type of a function <code class="docutils literal notranslate"><span class="pre">f</span></code> is not predictable just from the type of the input arguments alone.</p>
<p>Instructive example: <code class="docutils literal notranslate"><span class="pre">f(x)</span> <span class="pre">=</span> <span class="pre">rand()</span> <span class="pre">&gt;</span> <span class="pre">0.5</span> <span class="pre">?</span> <span class="pre">1.23</span> <span class="pre">:</span> <span class="pre">&quot;string&quot;</span></code></p>
<section id="example-global-scope">
<h3>Example: Global scope<a class="headerlink" href="#example-global-scope" title="Permalink to this headline">#</a></h3>
<p>A typical cause of type instability are global variables.</p>
<p>From a compiler perspective, variables defined in global scope <strong>can change their value and even their type(!) any time</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>()
  from f() in Main at In[22]:4
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Body<span class=" -Color -Color-Bold">::Any</span>
1 ─
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> %1 = (
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2 * Main.a)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">::Any</span>
│   %2 = (%1 + Main.b)<span class=" -Color -Color-Bold">::Any</span>
└──      return %2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>;  @ In[22]:4 within `f`
define 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nonnull <span class=" -Color -Color-Yellow">{}</span>* @julia_f_2890<span class=" -Color -Color-Yellow">()</span> #0 <span class=" -Color -Color-Yellow">{</span>
top:
  %0 = <span class=" -Color -Color-Bold">alloca</span> <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, align <span class=" -Color -Color-Yellow">8</span>
  %gcframe2 = <span class=" -Color -Color-Bold">alloca</span> <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, align <span class=" -Color -Color-Yellow">16</span>
  %gcframe2.sub = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>
  %.sub = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %0, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>
  %1 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2 to <span class=" -Color -Color-Cyan">i8</span>*
  <span class=" -Color -Color-Bold">call</span> <span class=" -Color -Color-Cyan">void</span> @llvm.memset.p0i8.i32<span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i8</span>* noundef nonnull align <span class=" -Color -Color-Yellow">16</span> dereferenceable<span class=" -Color -Color-Yellow">(32)</span> %1, <span class=" -Color -Color-Cyan">i8</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">32</span>, <span class=" -Color -Color-Cyan">i1</span> false<span class=" -Color -Color-Yellow">)</span>
  %thread_ptr = call <span class=" -Color -Color-Cyan">i8</span>* asm &quot;movq %fs:0, $0&quot;, &quot;=r&quot;<span class=" -Color -Color-Yellow">()</span> #3
  %ppgcstack_i8 = <span class=" -Color -Color-Bold">getelementptr</span> <span class=" -Color -Color-Cyan">i8</span>, <span class=" -Color -Color-Cyan">i8</span>* %thread_ptr, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">-8</span>
  %ppgcstack = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Cyan">i8</span>* %ppgcstack_i8 to <span class=" -Color -Color-Yellow">{}</span>****
  %pgcstack = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Yellow">{}</span>***, <span class=" -Color -Color-Yellow">{}</span>**** %ppgcstack, align <span class=" -Color -Color-Yellow">8</span>
  %2 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2 to <span class=" -Color -Color-Cyan">i64</span>*
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">8</span>, <span class=" -Color -Color-Cyan">i64</span>* %2, align <span class=" -Color -Color-Yellow">16</span>
  %3 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">1</span>
  %4 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">{}</span>** %3 to <span class=" -Color -Color-Yellow">{}</span>***
  %5 = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Yellow">{}</span>**, <span class=" -Color -Color-Yellow">{}</span>*** %pgcstack, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>** %5, <span class=" -Color -Color-Yellow">{}</span>*** %4, align <span class=" -Color -Color-Yellow">8</span>
  %6 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">{}</span>*** %pgcstack to <span class=" -Color -Color-Yellow">{}</span>***
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>** %gcframe2.sub, <span class=" -Color -Color-Yellow">{}</span>*** %6, align <span class=" -Color -Color-Yellow">8</span>
  %7 = <span class=" -Color -Color-Bold">load</span> atomic <span class=" -Color -Color-Yellow">{}</span>*, <span class=" -Color -Color-Yellow">{}</span>** inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139616999571672</span> to <span class=" -Color -Color-Yellow">{}</span>**<span class=" -Color -Color-Yellow">)</span> unordered, align <span class=" -Color -Color-Yellow">8</span>
  %8 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">2</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %7, <span class=" -Color -Color-Yellow">{}</span>** %8, align <span class=" -Color -Color-Yellow">16</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624437301408</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** %.sub, align <span class=" -Color -Color-Yellow">8</span>
  %9 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %0, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">1</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %7, <span class=" -Color -Color-Yellow">{}</span>** %9, align <span class=" -Color -Color-Yellow">8</span>
  %10 = <span class=" -Color -Color-Bold">call</span> nonnull <span class=" -Color -Color-Yellow">{}</span>* @ijl_apply_generic<span class=" -Color -Color-Yellow">({}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624224484400</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** nonnull %.sub, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">2)</span>
  %11 = <span class=" -Color -Color-Bold">load</span> atomic <span class=" -Color -Color-Yellow">{}</span>*, <span class=" -Color -Color-Yellow">{}</span>** inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139616982558104</span> to <span class=" -Color -Color-Yellow">{}</span>**<span class=" -Color -Color-Yellow">)</span> unordered, align <span class=" -Color -Color-Yellow">8</span>
  %12 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">3</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %10, <span class=" -Color -Color-Yellow">{}</span>** %12, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %11, <span class=" -Color -Color-Yellow">{}</span>** %8, align <span class=" -Color -Color-Yellow">16</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %10, <span class=" -Color -Color-Yellow">{}</span>** %.sub, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %11, <span class=" -Color -Color-Yellow">{}</span>** %9, align <span class=" -Color -Color-Yellow">8</span>
  %13 = <span class=" -Color -Color-Bold">call</span> nonnull <span class=" -Color -Color-Yellow">{}</span>* @ijl_apply_generic<span class=" -Color -Color-Yellow">({}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624222862560</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** nonnull %.sub, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">2)</span>
  %14 = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Yellow">{}</span>*, <span class=" -Color -Color-Yellow">{}</span>** %3, align <span class=" -Color -Color-Yellow">8</span>
  %15 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">{}</span>*** %pgcstack to <span class=" -Color -Color-Yellow">{}</span>**
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %14, <span class=" -Color -Color-Yellow">{}</span>** %15, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">ret</span> <span class=" -Color -Color-Yellow">{}</span>* %13
<span class=" -Color -Color-Yellow">}</span>
</pre></div>
</div>
</div>
</div>
<section id="fix-1-work-in-local-scope">
<h4>Fix 1: Work in local scope<a class="headerlink" href="#fix-1-work-in-local-scope" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="w">    </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="k">end</span>

<span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for local_scope()
  from local_scope() in Main at In[26]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(local_scope)</span>
Locals
  f<span class=" -Color -Color-Cyan">::var&quot;#f#7&quot;{Float64, Float64}</span>
  b<span class=" -Color -Color-Cyan">::Float64</span>
  a<span class=" -Color -Color-Cyan">::Float64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─      (a = 2.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>)
│        (b = 3.0)
│   %3 = Main.:(var&quot;#f#7&quot;)<span class=" -Color -Color-Cyan">::Core.Const(var&quot;#f#7&quot;)</span>
│   %4 = Core.typeof(b
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>::Core.Const(3.0))<span class=" -Color -Color-Cyan">::Core.Const(Float64)</span>
│   %5 = Core.typeof(a::Core.Const(2.0))<span class=" -Color -Color-Cyan">::Core.Const(Float64)</span>
│   %6 = Core.apply_type(%3, %4, %5)<span class=" -Color -Color-Cyan">::Core.Const(var&quot;#f#7&quot;{Float64, Float64})</span>
│   %7 = b<span class=" -Color -Color-Cyan">::Core.Const(3.0)</span>
│        (f = %new(%6, %7, a::Core.Const(2.0)))
│   %9 = (f::Core.Const(var&quot;#f#7&quot;{Float64, Float64}(3.0, 2.0)))()<span class=" -Color -Color-Cyan">::Core.Const(7.0)</span>
└──      return %9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>;  @ In[26]:1 within `local_scope`
define <span class=" -Color -Color-Cyan">double</span> @julia_local_scope_3014<span class=" -Color -Color-Yellow">()</span> #0 <span class=" -Color -Color-Yellow">{</span>
top:
  <span class=" -Color -Color-Bold">ret</span> <span class=" -Color -Color-Cyan">double</span> <span class=" -Color -Color-Yellow">7.000000e+00</span>
<span class=" -Color -Color-Yellow">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span><span class="w"> </span><span class="n">local_scope</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
	.file	&quot;local_scope&quot;
	.section	.rodata.cst8,&quot;aM&quot;,@progbits,<span class=" -Color -Color-Yellow">8</span>
	.p2align	<span class=" -Color -Color-Yellow">3</span>                               # -- Begin function julia_local_scope_3030
.LCPI0_0:
	.quad	<span class=" -Color -Color-Yellow">0x401c000000000000</span>              # double 7
	.text
	.globl	julia_local_scope_3030
	.p2align	<span class=" -Color -Color-Yellow">4</span>, <span class=" -Color -Color-Yellow">0x90</span>
	.type	julia_local_scope_3030,@function
julia_local_scope_3030:                 # @julia_local_scope_3030
; ┌ @ In[26]:1 within `local_scope`
	.cfi_startproc
# %bb.0:                                # %top
	<span class=" -Color -Color-Bold">movabsq</span>	$.LCPI0_0, %rax
	<span class=" -Color -Color-Bold">vmovsd</span>	<span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %xmm0                   # xmm0 = mem[0],zero
	<span class=" -Color -Color-Bold">retq</span>
.Lfunc_end0:
	.size	julia_local_scope_3030, .Lfunc_end0-julia_local_scope_3030
	.cfi_endproc
; └
                                        # -- End function
	.section	&quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits
</pre></div>
</div>
</div>
</div>
<p>This is fast.</p>
<p>In fact, it’s not just fast, but <strong>as fast as it can be</strong>! Julia has figured out the result of the calculation at compile-time and returns just the literal, i.e. <code class="docutils literal notranslate"><span class="pre">local_scope()</span> <span class="pre">=</span> <span class="pre">7</span></code>.</p>
</section>
<section id="fix-2-make-globals-constant">
<h4>Fix 2: Make globals <code class="docutils literal notranslate"><span class="pre">const</span></code>ant<a class="headerlink" href="#fix-2-make-globals-constant" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="k">const</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span>

<span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>;  @ In[30]:4 within `f`
define <span class=" -Color -Color-Cyan">double</span> @julia_f_3034<span class=" -Color -Color-Yellow">()</span> #0 <span class=" -Color -Color-Yellow">{</span>
top:
  <span class=" -Color -Color-Bold">ret</span> <span class=" -Color -Color-Cyan">double</span> <span class=" -Color -Color-Yellow">7.000000e+00</span>
<span class=" -Color -Color-Yellow">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[30]:4
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─ %1 = (2 * Main.C)<span class=" -Color -Color-Cyan">::Core.Const(4.0)</span>
│   %2 = (%1 + Main.D)<span class=" -Color -Color-Cyan">::Core.Const(7.0)</span>
└──      return %2
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-3-write-self-contained-functions">
<h4>Fix 3: Write self-contained functions<a class="headerlink" href="#fix-3-write-self-contained-functions" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 3 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>define <span class=" -Color -Color-Cyan">double</span> @julia_f_3042<span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">double</span> %0, <span class=" -Color -Color-Cyan">double</span> %1<span class=" -Color -Color-Yellow">)</span> #0 <span class=" -Color -Color-Yellow">{</span>
top:
  %2 = <span class=" -Color -Color-Bold">fmul</span> <span class=" -Color -Color-Cyan">double</span> %0, <span class=" -Color -Color-Yellow">2.000000e+00</span>
  %3 = <span class=" -Color -Color-Bold">fadd</span> <span class=" -Color -Color-Cyan">double</span> %2, %1
  <span class=" -Color -Color-Bold">ret</span> <span class=" -Color -Color-Cyan">double</span> %3
<span class=" -Color -Color-Yellow">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Write functions not scripts!</strong></p>
</section>
</section>
<section id="example-multiple-returns">
<h3>Example: Multiple Returns<a class="headerlink" href="#example-multiple-returns" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">flag</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Int64</span><span class="p">},</span><span class="w"> </span><span class="n">round</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 3 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::Vector{Float64}, ::Bool)
  from f(x, flag) in Main at In[35]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
  flag<span class=" -Color -Color-Cyan">::Bool</span>
Body<span class=" -Color -Color-Bold">::Union{Vector{Float64}, Vector{Int64}}</span>
1 ─      goto #3 if not flag
2 ─ %2 = Core.apply_type(Main.Vector, Main.Float64)<span class=" -Color -Color-Cyan">::Core.Const(Vector{Float64})</span>
│   %3 = Main.convert(%2, x)<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
└──      return %3
3 ─ %5 = Core.apply_type(Main.Vector, Main.Int64)<span class=" -Color -Color-Cyan">::Core.Const(Vector{Int64})</span>
│   %6 = Base.broadcasted(Main.round, x)<span class=" -Color -Color-Cyan">::Base.Broadcast.Broadcasted{Base.Broadcast.DefaultArrayStyle{1}, Nothing, typeof(round), Tuple{Vector{Float64}}}</span>
│   %7 = Base.materialize(%6)<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
│   %8 = Main.convert(%5, %7)<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
└──      return %8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Vector{Float64} (alias for Array{Float64, 1})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Vector{Int64} (alias for Array{Int64, 1})
</pre></div>
</div>
</div>
</div>
<section id="fix-hint-return-type">
<h4>Fix: Hint Return Type<a class="headerlink" href="#fix-hint-return-type" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">flag</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 3 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::Vector{Float64}, ::Bool)
  from f(x, flag) in Main at In[39]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
  flag<span class=" -Color -Color-Cyan">::Bool</span>
Body<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
1 ─ %1 = Core.apply_type(Main.Vector, Main.Float64)<span class=" -Color -Color-Cyan">::Core.Const(Vector{Float64})</span>
└──      goto #3 if not flag
2 ─ %3 = Main.length(x)<span class=" -Color -Color-Cyan">::Int64</span>
│   %4 = (1:%3)<span class=" -Color -Color-Cyan">::Core.PartialStruct(UnitRange{Int64}, Any[Core.Const(1), Int64])</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>│   %5 = Base.convert(%1, %4)<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
│   %6 = Core.typeassert(%5, %1)<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
└──      return %6
3 ─ %8 = Base.convert(%1, x)<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
│   %9 = Core.typeassert(%8, %1)<span class=" -Color -Color-Cyan">::Vector{Float64}</span>
└──      return %9
</pre></div>
</div>
</div>
</div>
<p>NB: Really, a <code class="docutils literal notranslate"><span class="pre">Union</span></code> return with a few types in it is not that bad as Julia typically handles this situation via union splitting. However it can make the compilers job harder.</p>
</section>
</section>
</section>
<section id="avoid-abstract-field-types">
<h2>Avoid Abstract Field Types<a class="headerlink" href="#avoid-abstract-field-types" title="Permalink to this headline">#</a></h2>
<p>A common reason for type inference to break are not-concretely typed fields in <code class="docutils literal notranslate"><span class="pre">struct</span></code>s</p>
<section id="example-1">
<h3>Example 1<a class="headerlink" href="#example-1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MyType</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">Number</span>
<span class="w">    </span><span class="n">y</span><span class="o">::</span><span class="kt">String</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="o">::</span><span class="kt">MyType</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 4 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyType</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::MyType)
  from f(a::MyType) in Main at In[42]:6
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  a<span class=" -Color -Color-Cyan">::MyType</span>
Body<span class=" -Color -Color-Bold">::Any</span>
1 ─ %1 = Base.getproperty(a, :x)<span class=" -Color -Color-Bold">::Number</span>
│   %2 = Core.apply_type(Base.Val, 2)<span class=" -Color -Color-Cyan">::Core.Const(Val{2})</span>
│   %3 = (%2)()<span class=" -Color -Color-Cyan">::Core.Const(Val{2}())</span>
│   %4 = Base.literal_pow(Main.:^, %1, %3)<span class=" -Color -Color-Bold">::Any</span>
│   %5 = Base.getproperty(a, :x)<span class=" -Color -Color-Bold">::Number</span>
│   %6 = Main.sqrt(%5)<span class=" -Color -Color-Bold">::Any</span>
│   %7 = (%4 + %6)<span class=" -Color -Color-Bold">::Any</span>
└──      return %7
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  62.344 ns (3 allocations: 48 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>;  @ In[42]:6 within `f`
define nonnull <span class=" -Color -Color-Yellow">{}</span>* @julia_f_3180<span class=" -Color -Color-Yellow">([2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* nocapture nonnull readonly align <span class=" -Color -Color-Yellow">8</span> dereferenceable<span class=" -Color -Color-Yellow">(16)</span> %0<span class=" -Color -Color-Yellow">)</span> #0 <span class=" -Color -Color-Yellow">{</span>
top:
  %1 = <span class=" -Color -Color-Bold">alloca</span> <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, align <span class=" -Color -Color-Yellow">8</span>
  %gcframe2 = <span class=" -Color -Color-Bold">alloca</span> <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, align <span class=" -Color -Color-Yellow">16</span>
  %gcframe2.sub = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>
  %.sub = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %1, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>
  %2 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2 to <span class=" -Color -Color-Cyan">i8</span>*
  <span class=" -Color -Color-Bold">call</span> <span class=" -Color -Color-Cyan">void</span> @llvm.memset.p0i8.i32<span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i8</span>* noundef nonnull align <span class=" -Color -Color-Yellow">16</span> dereferenceable<span class=" -Color -Color-Yellow">(32)</span> %2, <span class=" -Color -Color-Cyan">i8</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">32</span>, <span class=" -Color -Color-Cyan">i1</span> false<span class=" -Color -Color-Yellow">)</span>
  %thread_ptr = call <span class=" -Color -Color-Cyan">i8</span>* asm &quot;movq %fs:0, $0&quot;, &quot;=r&quot;<span class=" -Color -Color-Yellow">()</span> #3
  %ppgcstack_i8 = <span class=" -Color -Color-Bold">getelementptr</span> <span class=" -Color -Color-Cyan">i8</span>, <span class=" -Color -Color-Cyan">i8</span>* %thread_ptr, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">-8</span>
  %ppgcstack = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Cyan">i8</span>* %ppgcstack_i8 to <span class=" -Color -Color-Yellow">{}</span>****
  %pgcstack = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Yellow">{}</span>***, <span class=" -Color -Color-Yellow">{}</span>**** %ppgcstack, align <span class=" -Color -Color-Yellow">8</span>
; ┌ @ Base.jl:38 within `getproperty`
   %3 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2 to <span class=" -Color -Color-Cyan">i64</span>*
   <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">8</span>, <span class=" -Color -Color-Cyan">i64</span>* %3, align <span class=" -Color -Color-Yellow">16</span>
   %4 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">1</span>
   %5 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">{}</span>** %4 to <span class=" -Color -Color-Yellow">{}</span>***
   %6 = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Yellow">{}</span>**, <span class=" -Color -Color-Yellow">{}</span>*** %pgcstack, align <span class=" -Color -Color-Yellow">8</span>
   <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>** %6, <span class=" -Color -Color-Yellow">{}</span>*** %5, align <span class=" -Color -Color-Yellow">8</span>
   %7 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">{}</span>*** %pgcstack to <span class=" -Color -Color-Yellow">{}</span>***
   <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>** %gcframe2.sub, <span class=" -Color -Color-Yellow">{}</span>*** %7, align <span class=" -Color -Color-Yellow">8</span>
   %8 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[2</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %0, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>
   %9 = <span class=" -Color -Color-Bold">load</span> atomic <span class=" -Color -Color-Yellow">{}</span>*, <span class=" -Color -Color-Yellow">{}</span>** %8 unordered, align <span class=" -Color -Color-Yellow">8</span>
; └
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624223708144</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** %.sub, align <span class=" -Color -Color-Yellow">8</span>
  %10 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %1, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">1</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %9, <span class=" -Color -Color-Yellow">{}</span>** %10, align <span class=" -Color -Color-Yellow">8</span>
  %11 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[3</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %1, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">2</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624230823888</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** %11, align <span class=" -Color -Color-Yellow">8</span>
  %12 = <span class=" -Color -Color-Bold">call</span> nonnull <span class=" -Color -Color-Yellow">{}</span>* @ijl_apply_generic<span class=" -Color -Color-Yellow">({}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624223709712</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** nonnull %.sub, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">3)</span>
  %13 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">3</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %12, <span class=" -Color -Color-Yellow">{}</span>** %13, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %9, <span class=" -Color -Color-Yellow">{}</span>** %.sub, align <span class=" -Color -Color-Yellow">8</span>
  %14 = <span class=" -Color -Color-Bold">call</span> nonnull <span class=" -Color -Color-Yellow">{}</span>* @ijl_apply_generic<span class=" -Color -Color-Yellow">({}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624230843312</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** nonnull %.sub, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">1)</span>
  %15 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>, <span class=" -Color -Color-Yellow">[4</span> x <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">]</span>* %gcframe2, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">2</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %14, <span class=" -Color -Color-Yellow">{}</span>** %15, align <span class=" -Color -Color-Yellow">16</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %12, <span class=" -Color -Color-Yellow">{}</span>** %.sub, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %14, <span class=" -Color -Color-Yellow">{}</span>** %10, align <span class=" -Color -Color-Yellow">8</span>
  %16 = <span class=" -Color -Color-Bold">call</span> nonnull <span class=" -Color -Color-Yellow">{}</span>* @ijl_apply_generic<span class=" -Color -Color-Yellow">({}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624222862560</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Yellow">{}</span>** nonnull %.sub, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">2)</span>
  %17 = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Yellow">{}</span>*, <span class=" -Color -Color-Yellow">{}</span>** %4, align <span class=" -Color -Color-Yellow">8</span>
  %18 = <span class=" -Color -Color-Bold">bitcast</span> <span class=" -Color -Color-Yellow">{}</span>*** %pgcstack to <span class=" -Color -Color-Yellow">{}</span>**
  <span class=" -Color -Color-Bold">store</span> <span class=" -Color -Color-Yellow">{}</span>* %17, <span class=" -Color -Color-Yellow">{}</span>** %18, align <span class=" -Color -Color-Yellow">8</span>
  <span class=" -Color -Color-Bold">ret</span> <span class=" -Color -Color-Yellow">{}</span>* %16
<span class=" -Color -Color-Yellow">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MyType
</pre></div>
</div>
</div>
</div>
<p><strong>“Type stability”</strong>: A function <code class="docutils literal notranslate"><span class="pre">f</span></code> is type stable if for a given set of input argument types the return type is always the same and <em>concrete</em>.</p>
<section id="fix-1-concrete-typing">
<h4>Fix 1: Concrete typing<a class="headerlink" href="#fix-1-concrete-typing" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MyTypeConcrete</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">Float64</span>
<span class="w">    </span><span class="n">y</span><span class="o">::</span><span class="kt">String</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">MyTypeConcrete</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 5 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyTypeConcrete</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::MyTypeConcrete)
  from f(b::MyTypeConcrete) in Main at In[47]:6
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  b<span class=" -Color -Color-Cyan">::MyTypeConcrete</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─ %1 = Base.getproperty(b, :x)<span class=" -Color -Color-Cyan">::Float64</span>
│   %2 = Core.apply_type(Base.Val, 2)<span class=" -Color -Color-Cyan">::Core.Const(Val{2})</span>
│   %3 = (%2)()<span class=" -Color -Color-Cyan">::Core.Const(Val{2}())</span>
│   %4 = Base.literal_pow(Main.:^, %1, %3)<span class=" -Color -Color-Cyan">::Float64</span>
│   %5 = Base.getproperty(b, :x)<span class=" -Color -Color-Cyan">::Float64</span>
│   %6 = Main.sqrt(%5)<span class=" -Color -Color-Cyan">::Float64</span>
│   %7 = (%4 + %6)<span class=" -Color -Color-Cyan">::Float64</span>
└──      return %7
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">b</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3.433 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_llvm</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>;  @ In[47]:6 within `f`
define <span class=" -Color -Color-Cyan">double</span> @julia_f_3194<span class=" -Color -Color-Yellow">({</span> <span class=" -Color -Color-Cyan">double</span>, <span class=" -Color -Color-Yellow">{}</span>* <span class=" -Color -Color-Yellow">}</span>* nocapture nonnull readonly align <span class=" -Color -Color-Yellow">8</span> dereferenceable<span class=" -Color -Color-Yellow">(16)</span> %0<span class=" -Color -Color-Yellow">)</span> #0 <span class=" -Color -Color-Yellow">{</span>
top:
; ┌ @ Base.jl:38 within `getproperty`
   %1 = <span class=" -Color -Color-Bold">getelementptr</span> inbounds <span class=" -Color -Color-Yellow">{</span> <span class=" -Color -Color-Cyan">double</span>, <span class=" -Color -Color-Yellow">{}</span>* <span class=" -Color -Color-Yellow">}</span>, <span class=" -Color -Color-Yellow">{</span> <span class=" -Color -Color-Cyan">double</span>, <span class=" -Color -Color-Yellow">{}</span>* <span class=" -Color -Color-Yellow">}</span>* %0, <span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">0</span>, <span class=" -Color -Color-Cyan">i32</span> <span class=" -Color -Color-Yellow">0</span>
; └
; ┌ @ intfuncs.jl:321 within `literal_pow`
; │┌ @ float.jl:385 within `*`
    %2 = <span class=" -Color -Color-Bold">load</span> <span class=" -Color -Color-Cyan">double</span>, <span class=" -Color -Color-Cyan">double</span>* %1, align <span class=" -Color -Color-Yellow">8</span>
; └└
; ┌ @ math.jl:591 within `sqrt`
; │┌ @ float.jl:412 within `&lt;`
    %3 = <span class=" -Color -Color-Bold">fcmp</span> <span class=" -Color -Color-Bold">uge</span> <span class=" -Color -Color-Cyan">double</span> %2, <span class=" -Color -Color-Yellow">0.000000e+00</span>
; │└
   <span class=" -Color -Color-Bold">br</span> <span class=" -Color -Color-Cyan">i1</span> %3, <span class=" -Color -Color-Cyan">label</span> %L8, <span class=" -Color -Color-Cyan">label</span> %L6

L6:                                               ; preds = %top
   %4 = <span class=" -Color -Color-Bold">call</span> nonnull <span class=" -Color -Color-Yellow">{}</span>* @j_throw_complex_domainerror_3196<span class=" -Color -Color-Yellow">({}</span>* inttoptr <span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">i64</span> <span class=" -Color -Color-Yellow">139624437655464</span> to <span class=" -Color -Color-Yellow">{}</span>*<span class=" -Color -Color-Yellow">)</span>, <span class=" -Color -Color-Cyan">double</span> %2<span class=" -Color -Color-Yellow">)</span> #0
   <span class=" -Color -Color-Bold">call</span> <span class=" -Color -Color-Cyan">void</span> @llvm.trap<span class=" -Color -Color-Yellow">()</span>
   <span class=" -Color -Color-Bold">unreachable</span>

L8:                                               ; preds = %top
; └
; ┌ @ intfuncs.jl:321 within `literal_pow`
; │┌ @ float.jl:385 within `*`
    %5 = <span class=" -Color -Color-Bold">fmul</span> <span class=" -Color -Color-Cyan">double</span> %2, %2
; └└
; ┌ @ math.jl:592 within `sqrt`
   %6 = <span class=" -Color -Color-Bold">call</span> <span class=" -Color -Color-Cyan">double</span> @llvm.sqrt.f64<span class=" -Color -Color-Yellow">(</span><span class=" -Color -Color-Cyan">double</span> %2<span class=" -Color -Color-Yellow">)</span>
; └
; ┌ @ float.jl:383 within `+`
   %7 = <span class=" -Color -Color-Bold">fadd</span> <span class=" -Color -Color-Cyan">double</span> %5, %6
; └
  <span class=" -Color -Color-Bold">ret</span> <span class=" -Color -Color-Cyan">double</span> %7
<span class=" -Color -Color-Yellow">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-2-type-parameters">
<h4>Fix 2: Type parameters<a class="headerlink" href="#fix-2-type-parameters" title="Permalink to this headline">#</a></h4>
<p>But what if I want to accept any kind of, say, <code class="docutils literal notranslate"><span class="pre">Number</span></code> and <code class="docutils literal notranslate"><span class="pre">AbstractString</span></code> for our type?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MyTypeParametric</span><span class="p">{</span><span class="kt">A</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Number</span><span class="p">,</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractString</span><span class="p">}</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">A</span>
<span class="w">    </span><span class="n">y</span><span class="o">::</span><span class="kt">B</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="n">c</span><span class="o">::</span><span class="kt">MyTypeParametric</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 6 methods)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyTypeParametric</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MyTypeParametric{Float64, String}(3.0, &quot;test&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::MyTypeParametric{Float64, String})
  from f(c::MyTypeParametric) in Main at In[51]:6
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  c<span class=" -Color -Color-Cyan">::MyTypeParametric{Float64, String}</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─ %1 = Base.getproperty(c, :x)<span class=" -Color -Color-Cyan">::Float64</span>
│   %2 = Core.apply_type(Base.Val, 2)<span class=" -Color -Color-Cyan">::Core.Const(Val{2})</span>
│   %3 = (%2)()<span class=" -Color -Color-Cyan">::Core.Const(Val{2}())</span>
│   %4 = Base.literal_pow(Main.:^, %1, %3)<span class=" -Color -Color-Cyan">::Float64</span>
│   %5 = Base.getproperty(c, :x)<span class=" -Color -Color-Cyan">::Float64</span>
│   %6 = Main.sqrt(%5)<span class=" -Color -Color-Cyan">::Float64</span>
│   %7 = (%4 + %6)<span class=" -Color -Color-Cyan">::Float64</span>
└──      return %7
</pre></div>
</div>
</div>
</div>
<p>From the type alone the compiler knows what the structure contains and can produce optimal code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3.814 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyTypeParametric</span><span class="p">(</span><span class="kt">Float32</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span><span class="w"> </span><span class="kt">SubString</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MyTypeParametric{Float32, SubString{String}}(3.0f0, &quot;test&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">c</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  3.344 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="example-2-cooler-diagonal-matrix">
<h3>Example 2 - Cooler Diagonal Matrix<a class="headerlink" href="#example-2-cooler-diagonal-matrix" title="Permalink to this headline">#</a></h3>
<p>Yesterday we created a diagonal matrix which could take in a <code class="docutils literal notranslate"><span class="pre">Vector</span></code> and create an object that acted like a diagonal matrix.</p>
<p>By replacing the <code class="docutils literal notranslate"><span class="pre">Vector</span></code> with an <code class="docutils literal notranslate"><span class="pre">AbstractVector</span></code>, we made this work with anything vector-like, like ranges.</p>
<p>However, this ended up being slower than the original implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">DiagonalMatrix</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="mi">2</span><span class="p">}</span>
<span class="w">    </span><span class="n">diag</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">),</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.:+</span><span class="p">(</span><span class="n">Da</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">Db</span><span class="o">::</span><span class="kt">DiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">Da</span><span class="o">.</span><span class="n">diag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Db</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">CoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span>
<span class="w">    </span><span class="n">diag</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">),</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.:+</span><span class="p">(</span><span class="n">Da</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">Db</span><span class="o">::</span><span class="kt">CoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="n">Da</span><span class="o">.</span><span class="n">diag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Db</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span>

<span class="n">DM_cool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  84.073 ns (1 allocation: 896 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  188.554 ns (2 allocations: 912 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DM</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for +(::DiagonalMatrix{Int64}, ::DiagonalMatrix{Int64})
  from +(Da::DiagonalMatrix, Db::DiagonalMatrix) in Main at In[57]:15
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(+)</span>
  Da<span class=" -Color -Color-Cyan">::DiagonalMatrix{Int64}</span>
  Db<span class=" -Color -Color-Cyan">::DiagonalMatrix{Int64}</span>
Body<span class=" -Color -Color-Cyan">::DiagonalMatrix{Int64}</span>
1 ─ %1 = Base.getproperty(Da, :diag)<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
│   %2 = Base.getproperty(Db, :diag)<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
│   %3 = (%1 + %2)<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
│   %4 = Main.DiagonalMatrix(%3)<span class=" -Color -Color-Cyan">::DiagonalMatrix{Int64}</span>
└──      return %4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DM_cool</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for +(::CoolerDiagonalMatrix{Int64}, ::CoolerDiagonalMatrix{Int64})
  from +(Da::CoolerDiagonalMatrix, Db::CoolerDiagonalMatrix) in Main at In[58]:15
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(+)</span>
  Da<span class=" -Color -Color-Cyan">::CoolerDiagonalMatrix{Int64}</span>
  Db<span class=" -Color -Color-Cyan">::CoolerDiagonalMatrix{Int64}</span>
Body<span class=" -Color -Color-Bold">::CoolerDiagonalMatrix</span>
1 ─ %1 = Base.getproperty(Da, :diag)<span class=" -Color -Color-Bold">::AbstractVector{Int64}</span>
│   %2 = Base.getproperty(Db, :diag)<span class=" -Color -Color-Bold">::AbstractVector{Int64}</span>
│   %3 = (%1 + %2)<span class=" -Color -Color-Bold">::Any</span>
│   %4 = Main.CoolerDiagonalMatrix(%3)<span class=" -Color -Color-Bold">::CoolerDiagonalMatrix</span>
└──      return %4
</pre></div>
</div>
</div>
</div>
<p>This is the same as the previous problem: an <code class="docutils literal notranslate"><span class="pre">AbstractVector{Int64}</span></code> is not a concrete type, it means:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">subtypes</span><span class="p">(</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">Int64</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14-element Vector{Any}:
 AbstractRange{Int64}
 Base.LogicalIndex{Int64}
 Base.ReinterpretArray{Int64, 1, S} where S
 Base.ReshapedArray{Int64, 1}
 Core.Compiler.AbstractRange{Int64}
 Core.Compiler.LinearIndices{1, R} where R&lt;:Tuple{Core.Compiler.AbstractUnitRange{Int64}}
 DenseVector{Int64} (alias for DenseArray{Int64, 1})
 LinearIndices{1, R} where R&lt;:Tuple{AbstractUnitRange{Int64}}
 PermutedDimsArray{Int64, 1}
 AbstractSparseVector{Int64} (alias for SparseArrays.AbstractSparseArray{Int64, Ti, 1} where Ti)
 StaticArrays.TrivialView{A, Int64, 1} where A
 StaticArray{S, Int64, 1} where S&lt;:Tuple
 SubArray{Int64, 1}
 Test.GenericArray{Int64, 1}
</pre></div>
</div>
</div>
</div>
<p>So really it’s a union of all of the above types, not a single type!</p>
<p>We can avoid this with some slightly fancier code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="kt">U</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">}</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span>
<span class="w">    </span><span class="n">diag</span><span class="o">::</span><span class="kt">U</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">),</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">))</span>

<span class="k">function</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">getindex</span><span class="p">(</span><span class="n">D</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">::</span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="o">::</span><span class="kt">Int</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">D</span><span class="o">.</span><span class="n">diag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.:+</span><span class="p">(</span><span class="n">Da</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">Db</span><span class="o">::</span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="n">Da</span><span class="o">.</span><span class="n">diag</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Db</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">MethodError</span>: no method matching MuchCoolerDiagonalMatrix(::UnitRange{Int64})

<span class="ne">Stacktrace</span>:
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="o">@</span> <span class="n">In</span><span class="p">[</span><span class="mi">64</span><span class="p">]:</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>UnitRange{Int64}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="kt">UnitRange</span><span class="p">{</span><span class="kt">Int64</span><span class="p">}}(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10×10 MuchCoolerDiagonalMatrix{Int64, UnitRange{Int64}}:
 1  0  0  0  0  0  0  0  0   0
 0  2  0  0  0  0  0  0  0   0
 0  0  3  0  0  0  0  0  0   0
 0  0  0  4  0  0  0  0  0   0
 0  0  0  0  5  0  0  0  0   0
 0  0  0  0  0  6  0  0  0   0
 0  0  0  0  0  0  7  0  0   0
 0  0  0  0  0  0  0  8  0   0
 0  0  0  0  0  0  0  0  9   0
 0  0  0  0  0  0  0  0  0  10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="n">diag</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">eltype</span><span class="p">(</span><span class="kt">diag</span><span class="p">),</span><span class="w"> </span><span class="kt">typeof</span><span class="p">(</span><span class="kt">diag</span><span class="p">)}(</span><span class="n">diag</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MuchCoolerDiagonalMatrix
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="kt">MuchCoolerDiagonalMatrix</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="kt">UnitRange</span><span class="p">{</span><span class="kt">Int64</span><span class="p">}}(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10×10 MuchCoolerDiagonalMatrix{Int64, UnitRange{Int64}}:
 1  0  0  0  0  0  0  0  0   0
 0  2  0  0  0  0  0  0  0   0
 0  0  3  0  0  0  0  0  0   0
 0  0  0  4  0  0  0  0  0   0
 0  0  0  0  5  0  0  0  0   0
 0  0  0  0  0  6  0  0  0   0
 0  0  0  0  0  0  7  0  0   0
 0  0  0  0  0  0  0  8  0   0
 0  0  0  0  0  0  0  0  9   0
 0  0  0  0  0  0  0  0  0  10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span>

<span class="n">DM_cool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="p">;</span>

<span class="n">DM_mcool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  83.474 ns (1 allocation: 896 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  189.947 ns (2 allocations: 912 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  83.942 ns (1 allocation: 896 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DiagonalMatrix</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">))</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM</span>

<span class="n">DM_cool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoolerDiagonalMatrix</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">)</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_cool</span><span class="p">;</span>

<span class="n">DM_mcool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MuchCoolerDiagonalMatrix</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span><span class="p">)</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">$</span><span class="n">DM_mcool</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  84.192 ns (1 allocation: 896 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  121.758 ns (3 allocations: 112 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  12.050 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">DM_mcool</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DM_mcool</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for +(::MuchCoolerDiagonalMatrix{Int64, UnitRange{Int64}}, ::MuchCoolerDiagonalMatrix{Int64, UnitRange{Int64}})
  from +(Da::MuchCoolerDiagonalMatrix, Db::MuchCoolerDiagonalMatrix) in Main at In[63]:15
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(+)</span>
  Da<span class=" -Color -Color-Cyan">::MuchCoolerDiagonalMatrix{Int64, UnitRange{Int64}}</span>
  Db<span class=" -Color -Color-Cyan">::MuchCoolerDiagonalMatrix{Int64, UnitRange{Int64}}</span>
Body<span class=" -Color -Color-Cyan">::MuchCoolerDiagonalMatrix{Int64, StepRangeLen{Int64, Int64, Int64, Int64}}</span>
1 ─ %1 = Base.getproperty(Da, :diag)<span class=" -Color -Color-Cyan">::UnitRange{Int64}</span>
│   %2 = Base.getproperty(Db, :diag)<span class=" -Color -Color-Cyan">::UnitRange{Int64}</span>
│   %3 = (%1 + %2)<span class=" -Color -Color-Cyan">::Core.PartialStruct(StepRangeLen{Int64, Int64, Int64, Int64}, Any[Int64, Core.Const(2), Int64, Core.Const(1)])</span>
│   %4 = Main.MuchCoolerDiagonalMatrix(%3)<span class=" -Color -Color-Cyan">::Core.PartialStruct(MuchCoolerDiagonalMatrix{Int64, StepRangeLen{Int64, Int64, Int64, Int64}}, Any[Core.PartialStruct(StepRangeLen{Int64, Int64, Int64, Int64}, Any[Int64, Core.Const(2), Int64, Core.Const(1)])])</span>
└──      return %4
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="avoid-untyped-containers">
<h2>Avoid Untyped Containers<a class="headerlink" href="#avoid-untyped-containers" title="Permalink to this headline">#</a></h2>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  314.034 ns (3 allocations: 464 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[72]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Locals
  @_2<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  numbers<span class=" -Color -Color-Cyan">::Vector{Any}</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Bold">::Any</span>
1 ─       (numbers = Base.vect())
│   %2  = (1:10)<span class=" -Color -Color-Cyan">::Core.Const(1:10)</span>
│         (@_2 = Base.iterate(%2))
│   %4  = (@_2::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %5  = Base.not_int(%4)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %5
2 ┄ %7  = @_2<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%7, 1))
│   %9  = Core.getfield(%7, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│         Main.push!(numbers, i)
│         (@_2 = Base.iterate(%2, %9))
│   %12 = (@_2 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %13 = Base.not_int(%12)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %13
3 ─       goto #2
4 ┄ %16 = Main.sum(numbers)<span class=" -Color -Color-Bold">::Any</span>
└──       return %16
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">([])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Vector{Any} (alias for Array{Any, 1})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Int</span><span class="p">[]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  162.338 ns (3 allocations: 480 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[75]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Locals
  @_2<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  numbers<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Int64</span>
1 ─       (numbers = Base.getindex(Main.Int))
│   %2  = (1:10)<span class=" -Color -Color-Cyan">::Core.Const(1:10)</span>
│         (@_2 = Base.iterate(%2))
│   %4  = (@_2::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %5  = Base.not_int(%4)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %5
2 ┄ %7  = @_2<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%7, 1))
│   %9  = Core.getfield(%7, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│         Main.push!(numbers, i)
│         (@_2 = Base.iterate(%2, %9))
│   %12 = (@_2 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %13 = Base.not_int(%12)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %13
3 ─       goto #2
4 ┄ %16 = Main.sum(numbers)<span class=" -Color -Color-Cyan">::Int64</span>
└──       return %16
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="avoid-changing-variable-types">
<h2>Avoid Changing Variable Types<a class="headerlink" href="#avoid-changing-variable-types" title="Permalink to this headline">#</a></h2>
<p>Variables in a function should not change type.</p>
<section id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[77]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Locals
  @_2<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  x<span class=" -Color -Color-Bold">::Union{Float64, Int64}</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─       (x = 1)
│   %2  = (1:10)<span class=" -Color -Color-Cyan">::Core.Const(1:10)</span>
│         (@_2 = Base.iterate(%2))
│   %4  = (@_2::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %5  = Base.not_int(%4)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %5
2 ┄ %7  = @_2<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%7, 1))
│   %9  = Core.getfield(%7, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│   %10 = x<span class=" -Color -Color-Bold">::Union{Float64, Int64}</span>
│   %11 = Main.rand()<span class=" -Color -Color-Cyan">::Float64</span>
│         (x = %10 / %11)
│         (@_2 = Base.iterate(%2, %9))
│   %14 = (@_2 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %15 = Base.not_int(%14)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %15
3 ─       goto #2
4 ┄       return x::Float64
</pre></div>
</div>
</div>
</div>
<p>(On a side note: since the type can only vary between <code class="docutils literal notranslate"><span class="pre">Float64</span></code> and <code class="docutils literal notranslate"><span class="pre">Int64</span></code>, Julia can still produce reasonable code by <em>union splitting</em>. I recommend reading <a class="reference external" href="https://julialang.org/blog/2018/08/union-splitting">this blog post</a> by Tim Holy.)</p>
<section id="fix-1-initialize-with-correct-type">
<h4>Fix 1: Initialize with correct type<a class="headerlink" href="#fix-1-initialize-with-correct-type" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[78]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Locals
  @_2<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─       (x = 1.0)
│   %2  = (1:10)<span class=" -Color -Color-Cyan">::Core.Const(1:10)</span>
│         (@_2 = Base.iterate(%2))
│   %4  = (@_2::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %5  = Base.not_int(%4)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %5
2 ┄ %7  = @_2<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%7, 1))
│   %9  = Core.getfield(%7, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│   %10 = x<span class=" -Color -Color-Cyan">::Float64</span>
│   %11 = Main.rand()<span class=" -Color -Color-Cyan">::Float64</span>
│         (x = %10 / %11)
│         (@_2 = Base.iterate(%2, %9))
│   %14 = (@_2 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %15 = Base.not_int(%14)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %15
3 ─       goto #2
4 ┄       return x
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion">
<h4>Fix 2: Specify types (to get errors or to heal the problem by conversion)<a class="headerlink" href="#fix-2-specify-types-to-get-errors-or-to-heal-the-problem-by-conversion" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="o">::</span><span class="kt">Float64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c"># implicit conversion</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[79]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Locals
  @_2<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─ %1  = Base.convert(Main.Float64, 1)<span class=" -Color -Color-Cyan">::Core.Const(1.0)</span>
│         (x = Core.typeassert(%1, Main.Float64))
│   %3  = (1:10)<span class=" -Color -Color-Cyan">::Core.Const(1:10)</span>
│         (@_2 = Base.iterate(%3))
│   %5  = (@_2::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %6  = Base.not_int(%5)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %6
2 ┄ %8  = @_2<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%8, 1))
│   %10 = Core.getfield(%8, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│   %11 = x<span class=" -Color -Color-Cyan">::Float64</span>
│   %12 = Main.rand()<span class=" -Color -Color-Cyan">::Float64</span>
│   %13 = (%11 / %12)<span class=" -Color -Color-Cyan">::Float64</span>
│   %14 = Base.convert(Main.Float64, %13)<span class=" -Color -Color-Cyan">::Float64</span>
│         (x = Core.typeassert(%14, Main.Float64))
│         (@_2 = Base.iterate(%3, %10))
│   %17 = (@_2 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %18 = Base.not_int(%17)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %18
3 ─       goto #2
4 ┄       return x
</pre></div>
</div>
</div>
</div>
</section>
<section id="fix-3-special-case-first-iteration">
<h4>Fix 3: Special-case first iteration<a class="headerlink" href="#fix-3-special-case-first-iteration" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="mi">10</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f()
  from f() in Main at In[80]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
Locals
  @_2<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─ %1  = Main.rand()<span class=" -Color -Color-Cyan">::Float64</span>
│         (x = 1 / %1)
│   %3  = (2:10)<span class=" -Color -Color-Cyan">::Core.Const(2:10)</span>
│         (@_2 = Base.iterate(%3))
│   %5  = (@_2::Core.Const((2, 2)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %6  = Base.not_int(%5)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %6
2 ┄ %8  = @_2<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%8, 1))
│   %10 = Core.getfield(%8, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│   %11 = x<span class=" -Color -Color-Cyan">::Float64</span>
│   %12 = Main.rand()<span class=" -Color -Color-Cyan">::Float64</span>
│         (x = %11 / %12)
│         (@_2 = Base.iterate(%3, %10))
│   %15 = (@_2 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %16 = Base.not_int(%15)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %16
3 ─       goto #2
4 ┄       return x
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="isolate-unavoidable-type-instabilities">
<h2>Isolate Unavoidable Type Instabilities<a class="headerlink" href="#isolate-unavoidable-type-instabilities" title="Permalink to this headline">#</a></h2>
<p>Type instabilities can occur very naturally, for example when reading unknown user files or user input. Hence, not every instability can be avoided.</p>
<p>If that’s the case, isolate your expensive computation from the instability by putting it in a separate <em>kernel function</em> (also known as introducing a <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#kernel-functions">function barrier</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Union</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="kt">Float64</span><span class="p">,</span><span class="kt">String</span><span class="p">}[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">3.2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5-element Vector{Union{Float64, Int64, String}}:
 4
 2.0
  &quot;test&quot;
 3.2
 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@code_warntype</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for computation(::Vector{Union{Float64, Int64, String}})
  from computation(data) in Main at In[82]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(computation)</span>
  data<span class=" -Color -Color-Cyan">::Vector{Union{Float64, Int64, String}}</span>
Locals
  @_3<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─       (x = 1.0)
│   %2  = (1:100)<span class=" -Color -Color-Cyan">::Core.Const(1:100)</span>
│         (@_3 = Base.iterate(%2))
│   %4  = (@_3::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %5  = Base.not_int(%4)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %5
2 ┄ %7  = @_3<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%7, 1))
│   %9  = Core.getfield(%7, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│   %10 = Base.getindex(data, 1)<span class=" -Color -Color-Bold">::Union{Float64, Int64, String}</span>
│         (x = Main.sin(%10))
│   %12 = x<span class=" -Color -Color-Cyan">::Float64</span>
│   %13 = Base.getindex(data, 2)<span class=" -Color -Color-Bold">::Union{Float64, Int64, String}</span>
│         (x = %12 + %13)
│   %15 = x<span class=" -Color -Color-Cyan">::Float64</span>
│   %16 = Base.getindex(data, 4)<span class=" -Color -Color-Bold">::Union{Float64, Int64, String}</span>
│         (x = %15 * %16)
│         (@_3 = Base.iterate(%2, %9))
│   %19 = (@_3 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %20 = Base.not_int(%19)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %20
3 ─       goto #2
4 ┄       return x
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1.222 μs (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_computation_kernel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">_computation_kernel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">c</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>_computation_kernel (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for computation(::Vector{Union{Float64, Int64, String}})
  from computation(data) in Main at In[84]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(computation)</span>
  data<span class=" -Color -Color-Cyan">::Vector{Union{Float64, Int64, String}}</span>
Locals
  c<span class=" -Color -Color-Bold">::Union{Float64, Int64, String}</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  b<span class=" -Color -Color-Bold">::Union{Float64, Int64, String}</span>
  a<span class=" -Color -Color-Bold">::Union{Float64, Int64, String}</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─      (a = Base.getindex(data, 1))
│        (b = Base.getindex(data, 2))
│        (c = Base.getindex(data, 4))
│   %4 = Main._computation_kernel(a, b, c)<span class=" -Color -Color-Cyan">::Float64</span>
└──      return %4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_warntype</span><span class="w"> </span><span class="n">_computation_kernel</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for _computation_kernel(::Int64, ::Float64, ::Float64)
  from _computation_kernel(a, b, c) in Main at In[84]:8
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(_computation_kernel)</span>
  a<span class=" -Color -Color-Cyan">::Int64</span>
  b<span class=" -Color -Color-Cyan">::Float64</span>
  c<span class=" -Color -Color-Cyan">::Float64</span>
Locals
  @_5<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Tuple{Int64, Int64}}</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
  i<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─       (x = 1.0)
│   %2  = (1:100)<span class=" -Color -Color-Cyan">::Core.Const(1:100)</span>
│         (@_5 = Base.iterate(%2))
│   %4  = (@_5::Core.Const((1, 1)) === nothing)<span class=" -Color -Color-Cyan">::Core.Const(false)</span>
│   %5  = Base.not_int(%4)<span class=" -Color -Color-Cyan">::Core.Const(true)</span>
└──       goto #4 if not %5
2 ┄ %7  = @_5<span class=" -Color -Color-Cyan">::Tuple{Int64, Int64}</span>
│         (i = Core.getfield(%7, 1))
│   %9  = Core.getfield(%7, 2)<span class=" -Color -Color-Cyan">::Int64</span>
│         (x = Main.sin(a))
│         (x = x + b)
│         (x = x * c)
│         (@_5 = Base.iterate(%2, %9))
│   %14 = (@_5 === nothing)<span class=" -Color -Color-Cyan">::Bool</span>
│   %15 = Base.not_int(%14)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #4 if not %15
3 ─       goto #2
4 ┄       return x
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">computation</span><span class="p">(</span><span class="o">$</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  938.621 ns (1 allocation: 16 bytes)
</pre></div>
</div>
</div>
</div>
<p>Note that the computational kernel function is fully type inferred.</p>
</section>
<section id="access-arrays-in-column-major-order">
<h2>Access Arrays in Column-Major Order<a class="headerlink" href="#access-arrays-in-column-major-order" title="Permalink to this headline">#</a></h2>
<img src="../../static/column-major-2D.png" width=800px>
<p>Excellent page on this topic: <a class="reference external" href="https://book.sciml.ai/notes/02-Optimizing_Serial_Code/">https://book.sciml.ai/notes/02-Optimizing_Serial_Code/</a></p>
<p><strong>Fastest varying loop index goes first.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">fcol!</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">nothing</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">frow!</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">nothing</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>frow! (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">fcol!</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 5034 samples with 1 evaluation.
 Range (<span class=" -Color -Color-Bold -Color-Bold-Cyan">min</span> … <span class=" -Color -Color-Magenta">max</span>):  <span class=" -Color -Color-Bold -Color-Bold-Cyan">665.128 μs</span> … <span class=" -Color -Color-Magenta">  2.710 ms</span>  ┊ GC (min … max): 0.00% … 0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Blue">median</span>):     <span class=" -Color -Color-Bold -Color-Bold-Blue">722.871 μs               </span>┊ GC (median):    0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Green">mean</span> ± <span class=" -Color -Color-Green">σ</span>):   <span class=" -Color -Color-Bold -Color-Bold-Green">862.419 μs</span> ± <span class=" -Color -Color-Green">307.528 μs</span>  ┊ GC (mean ± σ):  0.00% ± 0.00%

    █<span class=" -Color -Color-Blue">▅</span>       <span class=" -Color -Color-Green"> </span>                                                   
  ▂▅█<span class=" -Color -Color-Blue">█</span>▂▂▃▆▄▂▂<span class=" -Color -Color-Green">▁</span>▁▁▂▁▁▂▂▂▂▁▁▁▁▁▁▁▁▁▁▂▃▄▂▂▂▁▂▂▂▂▂▂▂▂▁▁▁▁▂▂▁▂▂▂▂▃▃▂▂ ▂
  665 μs           Histogram: frequency by time         1.75 ms <span class=" -Color -Color-Bold">&lt;</span>

 Memory estimate: <span class=" -Color -Color-Yellow">0 bytes</span>, allocs estimate: <span class=" -Color -Color-Yellow">0</span>.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">frow!</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Int64</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 1833 samples with 1 evaluation.
 Range (<span class=" -Color -Color-Bold -Color-Bold-Cyan">min</span> … <span class=" -Color -Color-Magenta">max</span>):  <span class=" -Color -Color-Bold -Color-Bold-Cyan">2.205 ms</span> … <span class=" -Color -Color-Magenta">  4.453 ms</span>  ┊ GC (min … max): 0.00% … 0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Blue">median</span>):     <span class=" -Color -Color-Bold -Color-Bold-Blue">2.259 ms               </span>┊ GC (median):    0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Green">mean</span> ± <span class=" -Color -Color-Green">σ</span>):   <span class=" -Color -Color-Bold -Color-Bold-Green">2.589 ms</span> ± <span class=" -Color -Color-Green">512.858 μs</span>  ┊ GC (mean ± σ):  0.00% ± 0.00%

  ▄█<span class=" -Color -Color-Blue">▆</span>▄▃      ▁▁   <span class=" -Color -Color-Green"> </span>   ▁                          ▃▄▄▃▂   ▁▁    
  ██<span class=" -Color -Color-Blue">█</span>██▆▁▄▁▁▅██▇▅▁<span class=" -Color -Color-Green">▄</span>▇▇██▇▅▄▄▁▄▄▁▄▁▁▄▁▁▄▁▁▁▁▁▄▄▁▁▄▅█████▇▇███▇▅ █
  2.2 ms       Histogram: <span class=" -Color -Color-Bold">log(</span>frequency<span class=" -Color -Color-Bold">)</span> by time      3.62 ms <span class=" -Color -Color-Bold">&lt;</span>

 Memory estimate: <span class=" -Color -Color-Yellow">0 bytes</span>, allocs estimate: <span class=" -Color -Color-Yellow">0</span>.
</pre></div>
</div>
</div>
</div>
<p>Lots of cache misses for <code class="docutils literal notranslate"><span class="pre">frow</span></code>!</p>
</section>
<section id="performance-annotations">
<h2>Performance Annotations<a class="headerlink" href="#performance-annotations" title="Permalink to this headline">#</a></h2>
<section id="inbounds">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;inbounds</span></code><a class="headerlink" href="#inbounds" title="Permalink to this headline">#</a></h3>
<p>Disables bounds checks. (Julia may segfault if you use it wrongly!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
<span class="w">            </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  267.381 μs (1 allocation: 80 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f_inbounds</span><span class="p">()</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">100_000</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
<span class="w">            </span><span class="nd">@inbounds</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f_inbounds</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  501.242 μs (1 allocation: 80 bytes)
</pre></div>
</div>
</div>
</div>
</section>
<section id="simd">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;simd</span></code><a class="headerlink" href="#simd" title="Permalink to this headline">#</a></h3>
<p>Enables SIMD optimizations that are potentially <em>unsafe</em>. Julia may execute loop iterations in arbitrary or overlapping order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1.292 μs (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">f_simd</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zero</span><span class="p">(</span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">    </span><span class="nd">@simd</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span>
<span class="k">end</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f_simd</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  102.974 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<p>(For integer input both versions have the same speed because integer addition is associative, in contrast to floating point arithmetics.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">CpuId</span>
<span class="n">cpuinfo</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>| Cpu Property       | Value                                                      |
|:------------------ |:---------------------------------------------------------- |
| Brand              | Intel(R) Xeon(R) Silver 4214R CPU &#64; 2.40GHz                |
| Vendor             | :Intel                                                     |
| Architecture       | :Skylake                                                   |
| Model              | Family: 0x06, Model: 0x55, Stepping: 0x07, Type: 0x00      |
| Cores              | 12 physical cores, 24 logical cores (on executing CPU)     |
|                    | Hyperthreading hardware capability detected                |
| Clock Frequencies  | 2400 / 3500 MHz (base/max), 100 MHz bus                    |
| Data Cache         | Level 1:3 : (32, 1024, 16896) kbytes                       |
|                    | 64 byte cache line size                                    |
| Address Size       | 48 bits virtual, 46 bits physical                          |
| SIMD               | 512 bit = 64 byte max. SIMD vector size                    |
| Time Stamp Counter | TSC is accessible via <code class="docutils literal notranslate"><span class="pre">rdtsc</span></code>                              |
|                    | TSC runs at constant rate (invariant from clock frequency) |
| Perf. Monitoring   | Performance Monitoring Counters (PMC) revision 4           |
|                    | Available hardware counters per logical core:              |
|                    | 3 fixed-function counters of 48 bit width                  |
|                    | 4 general-purpose counters of 48 bit width                 |
| Hypervisor         | No                                                         |</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">f_simd</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1.292 μs (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  58.881 ns (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
</section>
<section id="fastmath">
<h3><code class="docutils literal notranslate"><span class="pre">&#64;fastmath</span></code><a class="headerlink" href="#fastmath" title="Permalink to this headline">#</a></h3>
<p>Enables lots of floating point optimizations that are potentially <em>unsafe</em>! It trades accuracy for speed, so, <a class="reference external" href="https://simonbyrne.github.io/notes/fastmath/">Beware of fast-math</a>. (See the <a class="reference external" href="https://llvm.org/docs/LangRef.html#fast-math-flags">LLVM Language Reference Manual</a> for more information on which compiler options it sets.)</p>
<p>There is <code class="docutils literal notranslate"><span class="pre">julia</span> <span class="pre">--math-mode=fast</span></code> to enable fast math globally.</p>
<p>Harmless example: <strong>FMA - Fused Multiply Add</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@noinline</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span>

<span class="nd">@code_native</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
	.file	&quot;f&quot;
	.globl	julia_f_4875                    # -- Begin function julia_f_4875
	.p2align	<span class=" -Color -Color-Yellow">4</span>, <span class=" -Color -Color-Yellow">0x90</span>
	.type	julia_f_4875,@function
julia_f_4875:                           # @julia_f_4875
	.cfi_startproc
# %bb.0:                                # %top
	<span class=" -Color -Color-Bold">vmulsd</span>	%xmm1, %xmm0, %xmm0
	<span class=" -Color -Color-Bold">vaddsd</span>	%xmm2, %xmm0, %xmm0
	<span class=" -Color -Color-Bold">retq</span>
.Lfunc_end0:
	.size	julia_f_4875, .Lfunc_end0-julia_f_4875
	.cfi_endproc
                                        # -- End function
	.section	&quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits
</pre></div>
</div>
</div>
</div>
<img src="../../static/skylake_microarchitecture.png" width=700px>
<p><strong>Source:</strong> <a class="reference external" href="https://software.intel.com/sites/default/files/managed/9e/bc/64-ia-32-architectures-optimization-manual.pdf">Intel® 64 and IA-32 Architectures Optimization Reference Manual</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f_fma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>

<span class="nd">@code_native</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f_fma</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
	.file	&quot;f_fma&quot;
	.globl	julia_f_fma_4877                # -- Begin function julia_f_fma_4877
	.p2align	<span class=" -Color -Color-Yellow">4</span>, <span class=" -Color -Color-Yellow">0x90</span>
	.type	julia_f_fma_4877,@function
julia_f_fma_4877:                       # @julia_f_fma_4877
	.cfi_startproc
# %bb.0:                                # %L7
	<span class=" -Color -Color-Bold">vfmadd213sd</span>	%xmm2, %xmm1, %xmm0     # xmm0 = (xmm1 * xmm0) + xmm2
	<span class=" -Color -Color-Bold">retq</span>
.Lfunc_end0:
	.size	julia_f_fma_4877, .Lfunc_end0-julia_f_fma_4877
	.cfi_endproc
                                        # -- End function
	.section	&quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f_fastmath</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@fastmath</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span>

<span class="nd">@code_native</span><span class="w"> </span><span class="n">debuginfo</span><span class="o">=</span><span class="ss">:none</span><span class="w"> </span><span class="n">f_fastmath</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
	.file	&quot;f_fastmath&quot;
	.globl	julia_f_fastmath_4881           # -- Begin function julia_f_fastmath_4881
	.p2align	<span class=" -Color -Color-Yellow">4</span>, <span class=" -Color -Color-Yellow">0x90</span>
	.type	julia_f_fastmath_4881,@function
julia_f_fastmath_4881:                  # @julia_f_fastmath_4881
	.cfi_startproc
# %bb.0:                                # %top
	<span class=" -Color -Color-Bold">vfmadd213sd</span>	%xmm2, %xmm1, %xmm0     # xmm0 = (xmm1 * xmm0) + xmm2
	<span class=" -Color -Color-Bold">retq</span>
.Lfunc_end0:
	.size	julia_f_fastmath_4881, .Lfunc_end0-julia_f_fastmath_4881
	.cfi_endproc
                                        # -- End function
	.section	&quot;.note.GNU-stack&quot;,&quot;&quot;,@progbits
</pre></div>
</div>
</div>
</div>
<p>Benchmarking this probably won’s show a difference due to the noise on the system dominating the tiny benefits of saving one instruction.</p>
<p>We get into this later</p>
<p>(P.S. In this specific case, <a class="reference external" href="https://github.com/SciML/MuladdMacro.jl">MuladdMacro.jl</a> is a <em>safe</em> alternative.</p>
</section>
</section>
<section id="cpu-operations-vary-in-cost">
<h2>CPU operations vary in cost<a class="headerlink" href="#cpu-operations-vary-in-cost" title="Permalink to this headline">#</a></h2>
<p><a class="reference external" href="http://ithare.com/infographics-operation-costs-in-cpu-clock-cycles/">http://ithare.com/infographics-operation-costs-in-cpu-clock-cycles/</a></p>
<section id="example-division-vs-multiplication">
<h3>Example: Division vs multiplication<a class="headerlink" href="#example-division-vs-multiplication" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="mi">1000</span>
<span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="mf">1e-3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mul (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">x</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>
<span class="nd">@btime</span><span class="w"> </span><span class="o">$</span><span class="n">x</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  939.900 ns (1 allocation: 7.94 KiB)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  882.800 ns (1 allocation: 7.94 KiB)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="analysis-tools">
<h2>Analysis Tools<a class="headerlink" href="#analysis-tools" title="Permalink to this headline">#</a></h2>
<section id="traceur-jl">
<h3><a class="reference external" href="https://github.com/MikeInnes/Traceur.jl">Traceur.jl</a><a class="headerlink" href="#traceur-jl" title="Permalink to this headline">#</a></h3>
<p><strong>Basic automatic performance trap checker</strong>. Essentially a codified version of the <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/">performance tips</a> in the Julia documentation.</p>
<p>Important macro: <a class="reference external" href="http://traceur.junolab.org/latest/#Traceur.&#64;trace"><code class="docutils literal notranslate"><span class="pre">&#64;trace</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Traceur</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>

<span class="nd">@trace</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>┌ Warning: uses global variable Main.a
└ @ In[103]:6
┌ Warning: uses global variable Main.b
└ @ In[103]:6
┌ Warning: dynamic dispatch to 2 * Main.a
└ @ In[103]:6
┌ Warning: dynamic dispatch to 2 * Main.a + Main.b
└ @ In[103]:6
┌ Warning: f returns Any
└ @ In[103]:6
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="jet-jl">
<h3><a class="reference external" href="https://github.com/aviatesk/JET.jl">JET.jl</a><a class="headerlink" href="#jet-jl" title="Permalink to this headline">#</a></h3>
<p><strong>Static</strong> code analyzer. (Doesn’t execute the code!)</p>
<p>Important macros:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;report_opt</span></code>: check for potential optimization problems (<a class="reference external" href="https://aviatesk.github.io/JET.jl/stable/optanalysis/">optimization analysis</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;report_call</span></code>: check for potential (general) errors (<a class="reference external" href="https://aviatesk.github.io/JET.jl/stable/jetanalysis/">error analysis</a>)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">JET</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span>

<span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span>

<span class="nd">@report_opt</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="c"># check for possible optimization problems</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>═════ 2 possible errors found ═════
┌ @ In[104]:6 2 * %1
│ runtime dispatch detected: <span class=" -Color -Color-Bold">(2 * %1::Any)::Any</span>
└─────────────
┌ @ In[104]:6 %2 + %3
│ runtime dispatch detected: <span class=" -Color -Color-Bold">(%2::Any + %3::Any)::Any</span>
└─────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>

<span class="nd">@report_call</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="c"># check for possible errors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No errors detected
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@report_opt</span><span class="w"> </span><span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>═════ 1 possible error found ═════
┌ @ In[105]:1 %1 + 2
│ runtime dispatch detected: <span class=" -Color -Color-Bold">(%1::Any + 2)::Any</span>
└─────────────
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@report_call</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="s">&quot;Hamburg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>═════ 2 possible errors found ═════
<span class=" -Color -Color-Magenta">┌ @ reduce.jl:557 </span>Base.:(var&quot;#sum#267&quot;)(pairs(NamedTuple()), #self#, a)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">┌ @ reduce.jl:557 </span>sum(identity, a)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">┌ @ reduce.jl:528 </span>Base.:(var&quot;#sum#266&quot;)(pairs(NamedTuple()), #self#, f, a)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">┌ @ reduce.jl:528 </span>mapreduce(f, Base.add_sum, a)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">┌ @ reduce.jl:302 </span>Base.:(var&quot;#mapreduce#263&quot;)(pairs(NamedTuple()), #self#, f, op, itr)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">┌ @ reduce.jl:302 </span>mapfoldl(f, op, itr)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">┌ @ reduce.jl:170 </span>Base.:(var&quot;#mapfoldl#259&quot;)(Base._InitialValue(), #self#, f, op, itr)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">┌ @ reduce.jl:170 </span>Base.mapfoldl_impl(f, op, init, itr)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">┌ @ reduce.jl:44 </span>Base.foldl_impl(op′, nt, itr′)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">┌ @ reduce.jl:48 </span>v = Base._foldl_impl(op, nt, itr)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">┌ @ reduce.jl:62 </span>v = op(v, y[1])
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">┌ @ reduce.jl:81 </span>op.rf(acc, x)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span>┌ @ reduce.jl:24 x + y
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span>│ no matching method found `+(::Char, ::Char)`: <span class=" -Color -Color-Bold">(x::Char + y::Char)</span>
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span>└────────────────
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">┌ @ reduce.jl:49 </span>Base.reduce_empty_iter(op, itr)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">┌ @ reduce.jl:378 </span>Base.reduce_empty_iter(op, itr, Base.IteratorEltype(itr))
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">┌ @ reduce.jl:379 </span>Base.reduce_empty(op, eltype(itr))
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">┌ @ reduce.jl:355 </span>Base.reduce_empty(op.rf, T)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">┌ @ reduce.jl:347 </span>Base.reduce_empty(+, T)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span>┌ @ reduce.jl:338 zero(T)
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span>│ no matching method found `zero(::Type{Char})`: <span class=" -Color -Color-Bold">zero(T::Type{Char})</span>
<span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span><span class=" -Color -Color-Yellow">│</span><span class=" -Color -Color-Green">│</span><span class=" -Color -Color-Magenta">│</span><span class=" -Color -Color-Blue">│</span>└─────────────────
</pre></div>
</div>
</div>
</div>
</section>
<section id="cthulhu-jl">
<h3><a class="reference external" href="https://github.com/JuliaDebug/Cthulhu.jl">Cthulhu.jl</a><a class="headerlink" href="#cthulhu-jl" title="Permalink to this headline">#</a></h3>
<p><strong>Interactive code explorer</strong> that let’s you navigate through a nested function call-tree and apply macros like <code class="docutils literal notranslate"><span class="pre">&#64;code_*</span></code>, or <code class="docutils literal notranslate"><span class="pre">&#64;which</span></code>, and more. For example, one can recursively apply <code class="docutils literal notranslate"><span class="pre">&#64;code_warntype</span></code> at different levels to detect the origin of a type instability. (Note though that it might take some time to master Cthulhu.)</p>
<p>Important macro: <code class="docutils literal notranslate"><span class="pre">&#64;descend</span></code> (or directly <code class="docutils literal notranslate"><span class="pre">&#64;descend_code_warntype</span></code>)</p>
<p>(Cthulhu isn’t a debugger! It has only “static” information.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Cthulhu</span>

<span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="c"># @descend A*B # doesn&#39;t work in Jupyter -&gt; use REPL</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10×10 Matrix{Float64}:
 0.308015  0.956787  0.93183   0.797131  …  0.932434  0.664151   0.811976
 0.204722  0.868462  0.19732   0.26474      0.854743  0.0633619  0.725818
 0.593911  0.527552  0.356724  0.613258     0.125343  0.269383   0.43678
 0.59512   0.356973  0.261443  0.18426      0.283995  0.626455   0.204825
 0.903477  0.22579   0.772885  0.172502     0.261419  0.36017    0.0108597
 0.445014  0.535388  0.239836  0.813443  …  0.149002  0.790049   0.265908
 0.239573  0.713987  0.476977  0.577885     0.259328  0.326482   0.851228
 0.861096  0.338257  0.488873  0.693131     0.26117   0.674127   0.774491
 0.662022  0.264346  0.659492  0.478881     0.577099  0.10761    0.342391
 0.523692  0.789614  0.936177  0.547415     0.337767  0.87931    0.364605
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>Start with optimising serial performance, bad serial code will be bad parallel code</p></li>
<li><p><strong>Reduce number of allocations</strong></p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">&#64;btime</span></code> to check the number of allocations</p></li>
<li><p>Avoid unnecessary allocations, huge no. of them is a bad sign</p></li>
</ul>
</li>
<li><p>Avoid temporary allocations</p>
<ul>
<li><p>e.g. dot syntax for broadcasting is very useful</p></li>
<li><p>Pre-allocating result arrays can save time</p></li>
</ul>
</li>
<li><p>Slicing by default <strong>copies data</strong>, use <code class="docutils literal notranslate"><span class="pre">&#64;views</span></code> or <code class="docutils literal notranslate"><span class="pre">view(A,</span> <span class="pre">1:2,</span> <span class="pre">1)</span></code> to get a non-copy view</p></li>
<li><p>(Lazy) generators can be much faster for certain tasks</p></li>
<li><p><strong>Type instability is VERY bad</strong></p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">&#64;code_warntype</span></code> to check for type instability</p></li>
<li><p>Avoid (non-constant) globals or work only in local scope</p></li>
<li><p>Hint return types if they are <code class="docutils literal notranslate"><span class="pre">Any</span></code> or <code class="docutils literal notranslate"><span class="pre">Union</span></code> (or rewrite code to avoid this)</p></li>
<li><p><strong>Avoid abstract types</strong> in containers</p>
<ul>
<li><p>Use concrete types</p></li>
<li><p>Or, for more flexibility, parametric types</p></li>
</ul>
</li>
<li><p>Avoid <strong>untyped</strong> containers, never use <code class="docutils literal notranslate"><span class="pre">[]</span></code>, use <code class="docutils literal notranslate"><span class="pre">Int[]</span></code>/<code class="docutils literal notranslate"><span class="pre">Float[]</span></code></p></li>
<li><p>Avoid <strong>changing</strong> types, e.g. <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">1;</span> <span class="pre">x</span> <span class="pre">/</span> <span class="pre">2</span></code> converts int to float</p></li>
<li><p>Isolate instabilities with <strong>computational kernels</strong></p></li>
</ul>
</li>
<li><p>Access arrays in <strong>column major</strong> order</p></li>
<li><p>Make use of performance annotations if applicable:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;inbounds</span></code> - no bounds checking</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;simd</span></code> - fused repeated operations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;fastmath</span></code> - fused multiply add operations</p></li>
</ul>
</li>
<li><p>Remember operations have different costs, e.g. <code class="docutils literal notranslate"><span class="pre">*</span></code> is faster than <code class="docutils literal notranslate"><span class="pre">/</span></code></p></li>
</ul>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/carstenbauer/JuliaHLRS22/blob/live/Day2/1_optimizing_serial_performance.ipynb">https://github.com/carstenbauer/JuliaHLRS22/blob/live/Day2/1_optimizing_serial_performance.ipynb</a></p></li>
<li><p><a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#man-performance-abstract-container">https://docs.julialang.org/en/v1/manual/performance-tips/#man-performance-abstract-container</a></p></li>
<li><p><a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/#kernel-functions">https://docs.julialang.org/en/v1/manual/performance-tips/#kernel-functions</a></p></li>
<li><p><a class="reference external" href="https://book.sciml.ai/notes/02-Optimizing_Serial_Code/">https://book.sciml.ai/notes/02-Optimizing_Serial_Code/</a></p></li>
</ul>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.8"
        },
        kernelOptions: {
            kernelName: "julia-1.8",
            path: "./sessions/2-serial"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.8'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../1-basics/6-pkg-management.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Package Management</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="2-simd.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">SIMD</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Robert Rosca<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>