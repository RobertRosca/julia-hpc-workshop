
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Distributed Computing: Distributed standard library &#8212; Julia for HPC&lt;br&gt;EuXFEL Workshop</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Distributed Computing: Message Passing Interface (MPI)" href="3-distributed-computing-mpi.html" />
    <link rel="prev" title="Parallel Computing" href="1-parallelism-concurrency.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.svg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Julia for HPC<br>EuXFEL Workshop</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Jupyter for HPC - EuXFEL Trial Run
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 1 - Basics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/0-syntax.html">
   Syntax
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/1-types-dispatch.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/2-duck-typing-benchmarking.html">
   Duck Typing, Interfaces, and Benchmarkin
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/3-specialization.html">
   Code Specialization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/4-generic-programming.html">
   Generic programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/5-workflow.html">
   Development Workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../1-basics/6-pkg-management.html">
   Package Management
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 2 - Serial
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../2-serial/1-optimizing-serial-performance.html">
   Optimizing “Serial” Performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../2-serial/2-simd.html">
   SIMD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../2-serial/3-interop-microbenchmark.html">
   Programming language interoperability (Interop)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../2-serial/4-linalg-pefrormance.html">
   Performance Considerations for Linear Algebra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Day 3 - Parallel
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1-parallelism-concurrency.html">
   Parallel Computing
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Distributed Computing:
   <code class="docutils literal notranslate">
    <span class="pre">
     Distributed
    </span>
   </code>
   standard library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3-distributed-computing-mpi.html">
   Distributed Computing: Message Passing Interface (MPI)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4-multithreading.html">
   Multithreading
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/robertrosca/julia-hpc-workshop/master?urlpath=tree/sessions/3-parallel/2-distributed-computing.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/robertrosca/julia-hpc-workshop"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/robertrosca/julia-hpc-workshop/issues/new?title=Issue%20on%20page%20%2Fsessions/3-parallel/2-distributed-computing.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/sessions/3-parallel/2-distributed-computing.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distributed-standard-library">
   <code class="docutils literal notranslate">
    <span class="pre">
     Distributed
    </span>
   </code>
   Standard Library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-controller-to-rule-them-all-spawn-spawnat-fetch-fetchfrom-everywhere">
     One Controller to Rule Them All -
     <code class="docutils literal notranslate">
      <span class="pre">
       @spawn
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @spawnat
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @fetch
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @fetchfrom
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @everywhere
      </span>
     </code>
     …
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-movement">
     Data movement
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#computer-latency-at-a-human-scale">
       Computer latency at a human scale
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-globals-once-more">
     Avoid Globals (once more)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#explicit-data-movement-channel-and-remotechannel">
     Explicit data movement:
     <code class="docutils literal notranslate">
      <span class="pre">
       Channel
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       RemoteChannel
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#remotechannel">
       <code class="docutils literal notranslate">
        <span class="pre">
         RemoteChannel
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#high-level-tools-distributed-and-pmap">
     High-level tools:
     <code class="docutils literal notranslate">
      <span class="pre">
       @distributed
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       pmap
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#distributed-loops-distributed">
       Distributed loops (
       <code class="docutils literal notranslate">
        <span class="pre">
         @distributed
        </span>
       </code>
       )
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-reduction">
       Example: Reduction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-common-mistake">
       A common mistake
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-sharedarrays">
       Example:
       <code class="docutils literal notranslate">
        <span class="pre">
         SharedArray
        </span>
       </code>
       s
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parallel-map-pmap">
     Parallel map:
     <code class="docutils literal notranslate">
      <span class="pre">
       pmap
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-singular-values-of-multiple-matrices">
       Example: Singular values of multiple matrices
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#when-to-choose-which-distributed-vs-pmap">
     When to choose which? (
     <code class="docutils literal notranslate">
      <span class="pre">
       @distributed
      </span>
     </code>
     vs
     <code class="docutils literal notranslate">
      <span class="pre">
       pmap
      </span>
     </code>
     )
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-level-array-abstractions-distributedarrays-jl">
   High-level array abstractions: DistributedArrays.jl
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#actual-distributed-computing-comments">
   <em>
    Actual
   </em>
   distributed computing: Comments
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-workers-on-other-machines">
     Creating workers on other machines
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Distributed Computing: Distributed standard library</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distributed-standard-library">
   <code class="docutils literal notranslate">
    <span class="pre">
     Distributed
    </span>
   </code>
   Standard Library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-controller-to-rule-them-all-spawn-spawnat-fetch-fetchfrom-everywhere">
     One Controller to Rule Them All -
     <code class="docutils literal notranslate">
      <span class="pre">
       @spawn
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @spawnat
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @fetch
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @fetchfrom
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       @everywhere
      </span>
     </code>
     …
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-movement">
     Data movement
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#computer-latency-at-a-human-scale">
       Computer latency at a human scale
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#avoid-globals-once-more">
     Avoid Globals (once more)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#explicit-data-movement-channel-and-remotechannel">
     Explicit data movement:
     <code class="docutils literal notranslate">
      <span class="pre">
       Channel
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       RemoteChannel
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#remotechannel">
       <code class="docutils literal notranslate">
        <span class="pre">
         RemoteChannel
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#high-level-tools-distributed-and-pmap">
     High-level tools:
     <code class="docutils literal notranslate">
      <span class="pre">
       @distributed
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       pmap
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#distributed-loops-distributed">
       Distributed loops (
       <code class="docutils literal notranslate">
        <span class="pre">
         @distributed
        </span>
       </code>
       )
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-reduction">
       Example: Reduction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-common-mistake">
       A common mistake
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-sharedarrays">
       Example:
       <code class="docutils literal notranslate">
        <span class="pre">
         SharedArray
        </span>
       </code>
       s
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parallel-map-pmap">
     Parallel map:
     <code class="docutils literal notranslate">
      <span class="pre">
       pmap
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-singular-values-of-multiple-matrices">
       Example: Singular values of multiple matrices
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#when-to-choose-which-distributed-vs-pmap">
     When to choose which? (
     <code class="docutils literal notranslate">
      <span class="pre">
       @distributed
      </span>
     </code>
     vs
     <code class="docutils literal notranslate">
      <span class="pre">
       pmap
      </span>
     </code>
     )
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#high-level-array-abstractions-distributedarrays-jl">
   High-level array abstractions: DistributedArrays.jl
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#actual-distributed-computing-comments">
   <em>
    Actual
   </em>
   distributed computing: Comments
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-workers-on-other-machines">
     Creating workers on other machines
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="distributed-computing-distributed-standard-library">
<h1>Distributed Computing: <code class="docutils literal notranslate"><span class="pre">Distributed</span></code> standard library<a class="headerlink" href="#distributed-computing-distributed-standard-library" title="Permalink to this headline">#</a></h1>
<p><strong>What</strong></p>
<ul class="simple">
<li><p><strong>single Julia process -&gt; multiple Julia processes</strong> that coordinate to perform certain computations</p></li>
</ul>
<p><strong>Why</strong></p>
<ul class="simple">
<li><p>Scaling things up: run computations on multiple CPU cores, potentially even on different machines, e.g. nodes of a supercomputer or a local cluster of desktop machines.</p></li>
<li><p>Effectively increase your memory: process a large dataset, which wouldn’t fit into local memory, in parallel across multiple machines with separate dedicated RAM.</p></li>
</ul>
<p><strong>Julia provides two fundamental implementations and paradigms</strong></p>
<ul class="simple">
<li><p>Julia’s built-in <a class="reference external" href="https://docs.julialang.org/en/v1/stdlib/Distributed/"><code class="docutils literal notranslate"><span class="pre">Distributed</span></code> standard library</a></p>
<ul>
<li><p>controller-worker model</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.mpi-forum.org/">Message Passing Interface (MPI)</a> through <a class="reference external" href="https://github.com/JuliaParallel/MPI.jl">MPI.jl</a></p>
<ul>
<li><p>Single Program Multiple Data (SPMD)</p></li>
</ul>
</li>
</ul>
<p>The focus of this notebook is on the <strong><code class="docutils literal notranslate"><span class="pre">Distributed</span></code> standard library.</strong></p>
<section id="distributed-standard-library">
<h2><code class="docutils literal notranslate"><span class="pre">Distributed</span></code> Standard Library<a class="headerlink" href="#distributed-standard-library" title="Permalink to this headline">#</a></h2>
<p>Julia’s <code class="docutils literal notranslate"><span class="pre">Distributed</span></code> follows a controller-worker paradigm for its native distributed parallelism: <strong>One controller process coordinates all the worker processes, which perform the actual computations.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Distributed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">nprocs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">nworkers</span><span class="p">()</span><span class="w"> </span><span class="c"># the controller is considered a worker as long as there are no real workers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>To increase the number of workers, i.e. Julia processes, from within a Julia session we can dynamically call <strong><code class="docutils literal notranslate"><span class="pre">addprocs</span></code></strong>.</p>
<p>Alternatively, when starting Julia from the command line, one can use the <code class="docutils literal notranslate"><span class="pre">-p</span></code> option up front. Example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">julia</span> <span class="o">-</span><span class="n">p</span> <span class="mi">4</span>
</pre></div>
</div>
<p>will start Julia with 5 processes, 1 controller and 4 workers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">addprocs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 2
 3
 4
 5
</pre></div>
</div>
</div>
</div>
<p>Every process has a Julia internal <code class="docutils literal notranslate"><span class="pre">pid</span></code> (process id). The controller is always 1. You can get the workers pids from <code class="docutils literal notranslate"><span class="pre">workers()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">workers</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 2
 3
 4
 5
</pre></div>
</div>
</div>
</div>
<p>Note that the 4 worker’s pids aren’t necessarily 2, 3, 4 and 5 and one shouldn’t rely on those literal values. Let’s remove the processes and add them once more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">rmprocs</span><span class="p">(</span><span class="n">workers</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Task (done) @0x00007fd3923b33d0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">nworkers</span><span class="p">()</span><span class="w"> </span><span class="c"># only the controller is left</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">addprocs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 6
 7
 8
 9
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">workers</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 6
 7
 8
 9
</pre></div>
</div>
</div>
</div>
<section id="one-controller-to-rule-them-all-spawn-spawnat-fetch-fetchfrom-everywhere">
<h3>One Controller to Rule Them All - <code class="docutils literal notranslate"><span class="pre">&#64;spawn</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;spawnat</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;fetch</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;fetchfrom</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;everywhere</span></code>…<a class="headerlink" href="#one-controller-to-rule-them-all-spawn-spawnat-fetch-fetchfrom-everywhere" title="Permalink to this headline">#</a></h3>
<p>To execute commands and start computations on workers we can use the following macros</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;spawn</span></code>: run a command or a code block on any worker and return a <code class="docutils literal notranslate"><span class="pre">Future</span></code> to it’s result. It’s basically a version of <code class="docutils literal notranslate"><span class="pre">&#64;async</span></code> for remote processes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;spawnat</span></code>: same as <code class="docutils literal notranslate"><span class="pre">&#64;spawn</span></code> but one can choose a specific worker by providing its pid.</p></li>
</ul>
<p><strong>Example:</strong> Let’s say we would like to generate a random matrix on one of the workers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@spawn</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c"># similar to @async</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Future(6, 1, 10, ReentrantLock(nothing, 0x00000000, 0x00, Base.GenericCondition{Base.Threads.SpinLock}(Base.InvasiveLinkedList{Task}(nothing, nothing), Base.Threads.SpinLock(0)), (0, 140546507405360, 140546684181032)), nothing)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@spawn</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Future(7, 1, 11, ReentrantLock(nothing, 0x00000000, 0x00, Base.GenericCondition{Base.Threads.SpinLock}(Base.InvasiveLinkedList{Task}(nothing, nothing), Base.Threads.SpinLock(0)), (2, 140546635279696, 140546656613456)), nothing)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">fetch</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<p>Because the combination of spawning at fetching is so common, there is <code class="docutils literal notranslate"><span class="pre">&#64;fetch</span></code> which combines them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@fetch</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@fetch</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3×3 Matrix{Float64}:
 0.100261  0.0803475  0.733105
 0.10801   0.199029   0.315599
 0.400162  0.0695813  0.865029
</pre></div>
</div>
</div>
</div>
<p>Which worker did the work?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@fetch</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello, I am </span><span class="si">$</span><span class="p">(</span><span class="n">myid</span><span class="p">())</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 6:	Hello, I am 6
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">&#64;spawnat</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;fetchfrom</span></code> we can delegate the work to a specific worker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@fetchfrom</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">myid</span><span class="p">())</span>
<span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 7:	7
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">&#64;sync</span></code> as a blocker to wait for all workers to complete their tasks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@sync</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">pids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">workers</span><span class="p">()</span>
<span class="w">    </span><span class="nd">@spawn</span><span class="w"> </span><span class="p">(</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Today is reverse day!&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nd">@spawn</span><span class="w"> </span><span class="p">(</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">&quot; class!&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nd">@spawn</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span>
<span class="k">end</span><span class="p">;</span>
<span class="n">println</span><span class="p">(</span><span class="s">&quot;Done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[6, 7, 8, 9]
      From worker 9:	Hello
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 8:	 class!
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 7:	Today is reverse day!
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done!
</pre></div>
</div>
</div>
</div>
<p>Ok, now that we understood all that, let’s delegate a <em>complicated</em> calculation</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Random</span>

<span class="k">function</span><span class="w"> </span><span class="n">complicated_calculation</span><span class="p">()</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c"># so complex that it takes a long time :)</span>
<span class="w">    </span><span class="n">randexp</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">end</span>

<span class="nd">@fetch</span><span class="w"> </span><span class="n">complicated_calculation</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">On</span> <span class="n">worker</span> <span class="mi">6</span><span class="p">:</span>
<span class="ne">UndefVarError</span>: #complicated_calculation not defined
<span class="ne">Stacktrace</span>:
  <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">deserialize_datatype</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">1364</span>
  <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">handle_deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">866</span>
  <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">813</span>
  <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">handle_deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">873</span>
  <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">813</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
  <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">deserialize_global_from_main</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">clusterserialize</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">160</span>
  <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="c1">#5</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">clusterserialize</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">72</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
  <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">foreach</span>
    <span class="o">@</span> <span class="o">./</span><span class="n">abstractarray</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">2774</span>
  <span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="n">deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">clusterserialize</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">72</span>
 <span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="n">handle_deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">959</span>
 <span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="n">deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">813</span>
 <span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="n">handle_deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">870</span>
 <span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="n">deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">813</span>
 <span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="n">handle_deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">873</span>
 <span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="n">deserialize</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Serialization</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Serialization</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">813</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">deserialize_msg</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">messages</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">87</span>
 <span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="c1">#invokelatest#2</span>
    <span class="o">@</span> <span class="o">./</span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">729</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="n">invokelatest</span>
    <span class="o">@</span> <span class="o">./</span><span class="n">essentials</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">726</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="n">message_handler_loop</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">process_messages</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">176</span>
 <span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="n">process_tcp_streams</span>
    <span class="o">@</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">process_messages</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">133</span>
 <span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="c1">#103</span>
    <span class="o">@</span> <span class="o">./</span><span class="n">task</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">484</span>

<span class="ne">Stacktrace</span>:
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">remotecall_fetch</span><span class="p">(::</span><span class="n">Function</span><span class="p">,</span> <span class="p">::</span><span class="n">Distributed</span><span class="o">.</span><span class="n">Worker</span><span class="p">;</span> <span class="n">kwargs</span><span class="p">::</span><span class="n">Base</span><span class="o">.</span><span class="n">Pairs</span><span class="p">{</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Union</span><span class="p">{},</span> <span class="n">Tuple</span><span class="p">{},</span> <span class="n">NamedTuple</span><span class="p">{(),</span> <span class="n">Tuple</span><span class="p">{}}})</span>
   <span class="o">@</span> <span class="n">Distributed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">remotecall</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">465</span>
 <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">remotecall_fetch</span><span class="p">(::</span><span class="n">Function</span><span class="p">,</span> <span class="p">::</span><span class="n">Distributed</span><span class="o">.</span><span class="n">Worker</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Distributed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">remotecall</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">454</span>
 <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">remotecall_fetch</span><span class="p">(::</span><span class="n">Function</span><span class="p">,</span> <span class="p">::</span><span class="n">Int64</span><span class="p">;</span> <span class="n">kwargs</span><span class="p">::</span><span class="n">Base</span><span class="o">.</span><span class="n">Pairs</span><span class="p">{</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Union</span><span class="p">{},</span> <span class="n">Tuple</span><span class="p">{},</span> <span class="n">NamedTuple</span><span class="p">{(),</span> <span class="n">Tuple</span><span class="p">{}}})</span>
   <span class="o">@</span> <span class="n">Distributed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">remotecall</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">492</span>
 <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">remotecall_fetch</span><span class="p">(::</span><span class="n">Function</span><span class="p">,</span> <span class="p">::</span><span class="n">Int64</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Distributed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">stdlib</span><span class="o">/</span><span class="n">v1</span><span class="mf">.8</span><span class="o">/</span><span class="n">Distributed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">remotecall</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">492</span>
 <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="o">@</span> <span class="n">In</span><span class="p">[</span><span class="mi">18</span><span class="p">]:</span><span class="mi">8</span>
</pre></div>
</div>
</div>
</div>
<p>What happened?</p>
<p><strong>Every worker is a separate Julia process.</strong> (Think of having multiple Julia REPLs open at once.)</p>
<p>We only defined <code class="docutils literal notranslate"><span class="pre">complicated_calculation()</span></code> on the controller process. The function doesn’t exist on any of the workers yet.</p>
<p>The macro <code class="docutils literal notranslate"><span class="pre">&#64;everywhere</span></code> allows us to perform steps on all processes (controller and worker). This is particularly useful for loading packages and functions definitions etc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@everywhere</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c"># execute this block on all workers</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">Random</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">complicated_calculation</span><span class="p">()</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">randexp</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="c"># lives in Random</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@fetch</span><span class="w"> </span><span class="n">complicated_calculation</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5-element Vector{Float64}:
 0.11101439273745213
 1.6327390625768725
 1.0539457430204437
 0.625053849763627
 0.05593522716795368
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-movement">
<h3>Data movement<a class="headerlink" href="#data-movement" title="Permalink to this headline">#</a></h3>
<p>There is a crucial difference between the following two pieces of code. Can you guess what it is? (without reading on 😉)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">method1</span><span class="p">()</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@fetch</span><span class="w"> </span><span class="n">A</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="o">^</span><span class="mi">2</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>method1 (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">method2</span><span class="p">()</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@fetch</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>method2 (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>Let’s benchmark them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">method1</span><span class="p">();</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">method2</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  439.248 μs (97 allocations: 237.96 KiB)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  361.266 μs (75 allocations: 81.11 KiB)
</pre></div>
</div>
</div>
</div>
<p>Method 1 is slower, because <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> are created on the controller process, transferred to a worker, and squared and multiplied on the worker process before the result is finally transferred back to the controller.</p>
<p>Method 2, on the other hand, creates, squares, and multiplies the random matrix all on the work process and only submits the result to the controller.</p>
<p>Hence, <code class="docutils literal notranslate"><span class="pre">method1</span></code> is <strong>transferring 3x as much data</strong> between the controller and the worker!</p>
<p><strong>Efficient data movement is crucial for efficient parallel computing!</strong></p>
<p>In this toy example, it’s rather easy to identify the faster method.</p>
<p>In a real program, however, understanding data movement does require more thought and likely some measurement.</p>
<p>For example, if the first process needs matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> in a follow-up computation then the first method might be better in this case. Or, if computing <code class="docutils literal notranslate"><span class="pre">A</span></code> is expensive and only the current process has it, then moving it to another process might be unavoidable.</p>
<section id="computer-latency-at-a-human-scale">
<h4>Computer latency at a human scale<a class="headerlink" href="#computer-latency-at-a-human-scale" title="Permalink to this headline">#</a></h4>
<p>To understand why thinking about data is important it’s instructive to look at the time scales involved in data access.</p>
<img src="../../static/latency_human_scales.png" width=900px>
<p>(taken from <a class="reference external" href="https://www.prowesscorp.com/computer-latency-at-a-human-scale/">https://www.prowesscorp.com/computer-latency-at-a-human-scale/</a>)</p>
</section>
</section>
<section id="avoid-globals-once-more">
<h3>Avoid Globals (once more)<a class="headerlink" href="#avoid-globals-once-more" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">myglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">whohas</span><span class="p">(</span><span class="n">s</span><span class="o">::</span><span class="kt">String</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@everywhere</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Symbol</span><span class="p">(</span><span class="o">$</span><span class="n">s</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isdefined</span><span class="p">(</span><span class="n">Main</span><span class="p">,</span><span class="w"> </span><span class="n">var</span><span class="p">)</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;</span><span class="si">$var</span><span class="s"> exists.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Doesn&#39;t exist.&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="nb">nothing</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>whohas (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">whohas</span><span class="p">(</span><span class="s">&quot;myglobal&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>myglobal exists.
      From worker 6:	Doesn&#39;t exist.
      From worker 8:	Doesn&#39;t exist.
      From worker 9:	Doesn&#39;t exist.
      From worker 7:	Doesn&#39;t exist.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@fetchfrom</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">myglobal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">whohas</span><span class="p">(</span><span class="s">&quot;myglobal&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>myglobal exists.
      From worker 7:	Doesn&#39;t exist.
      From worker 8:	Doesn&#39;t exist.
      From worker 9:	Doesn&#39;t exist.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 6:	myglobal exists.
</pre></div>
</div>
</div>
</div>
<p>Globals get copied to workers and continue to exist as globals even after the call.</p>
<p>This could lead to <strong>memory accumulation</strong> if many globals are used (just as it would in a single Julia session).</p>
<p>It’s better to avoid them.</p>
</section>
<section id="explicit-data-movement-channel-and-remotechannel">
<h3>Explicit data movement: <code class="docutils literal notranslate"><span class="pre">Channel</span></code> and <code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code><a class="headerlink" href="#explicit-data-movement-channel-and-remotechannel" title="Permalink to this headline">#</a></h3>
<p>Implement communication between tasks. Functions: <code class="docutils literal notranslate"><span class="pre">put!</span></code>, <code class="docutils literal notranslate"><span class="pre">take!</span></code>, <code class="docutils literal notranslate"><span class="pre">fetch</span></code>, <code class="docutils literal notranslate"><span class="pre">isready</span></code> and <code class="docutils literal notranslate"><span class="pre">wait</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Int</span><span class="p">}(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="c"># a channel that can hold up to 5 integers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Channel{Int64}(5) (empty)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">isready</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="c"># something in the channel?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>false
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">put!</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">isready</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>true
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">fetch</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">take!</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">isready</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>false
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">put!</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">fetch</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">take!</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<p><strong>Be careful</strong>, <code class="docutils literal notranslate"><span class="pre">take!</span></code> and <code class="docutils literal notranslate"><span class="pre">put!</span></code> are blocking if the channel is empty or full!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">isready</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>false
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># take!(ch) if we execute this, while isready(ch) == false, the current Julia session will hang.</span>
</pre></div>
</div>
</div>
</div>
<section id="remotechannel">
<h4><code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code><a class="headerlink" href="#remotechannel" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Channel</span></code> is local to a process. Worker 2 cannot directly refer to a <code class="docutils literal notranslate"><span class="pre">Channel</span></code> on worker 3 and vice-versa.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code>, however, can put and take values across workers. A <code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code> can be thought of as a handle to a <code class="docutils literal notranslate"><span class="pre">Channel</span></code>.</p></li>
<li><p>Any process with a reference to a <code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code> can put and take items from the channel. Data is automatically sent to (or retrieved from) the process a <code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code> is associated with.</p></li>
<li><p>The process id, pid, associated with a <code class="docutils literal notranslate"><span class="pre">RemoteChannel</span></code> identifies the process where the backing store, i.e., the backing Channel exists.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">nworkers</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">addprocs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 10
 11
 12
 13
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">do_something</span><span class="p">()</span>
<span class="w">    </span><span class="n">rc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RemoteChannel</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Channel</span><span class="p">{</span><span class="kt">Int</span><span class="p">}(</span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="c"># lives on the controller</span>
<span class="w">    </span><span class="nd">@sync</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">workers</span><span class="p">()</span>
<span class="w">        </span><span class="nd">@spawnat</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">put!</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="w"> </span><span class="n">myid</span><span class="p">())</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">rc</span>
<span class="k">end</span>

<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RemoteChannel{Channel{Int64}}(1, 1, 36698)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">isready</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>true
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="n">isready</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@show</span><span class="w"> </span><span class="n">take!</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>take!(r) = 6
take!(r) = 9
take!(r) = 7
take!(r) = 8
take!(r) = 12
take!(r) = 10
take!(r) = 13
take!(r) = 11
</pre></div>
</div>
</div>
</div>
<p>The ecosystem also contains a couple of tools, that make data transfer even simpler. See for example <a class="reference external" href="https://github.com/ChrisRackauckas/ParallelDataTransfer.jl/">ParallelDataTransfer.jl</a>.</p>
</section>
</section>
<section id="high-level-tools-distributed-and-pmap">
<h3>High-level tools: <code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code> and <code class="docutils literal notranslate"><span class="pre">pmap</span></code><a class="headerlink" href="#high-level-tools-distributed-and-pmap" title="Permalink to this headline">#</a></h3>
<p>So far we have seen some of the fundamental building blocks for distributed computing in Julia. However, in practice, one wants to think as little as possible about how to distribute the work and explicitly spawn tasks.</p>
<p>Fortunately, many useful parallel computations do not require (much) data movement at all. A common example is a direct Monte Carlo simulation, where multiple processes can handle independent simulation trials simultaneously. (We’ll get to that later in the exercises!)</p>
<p>Julia provides <strong>high-level convenience</strong> tools to</p>
<ul class="simple">
<li><p>parallelize loops (<a class="reference external" href="https://docs.julialang.org/en/v1/stdlib/Distributed/#Distributed.&#64;distributed"><strong><code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code></strong></a>) and</p></li>
<li><p>apply a function to all elements of a collection (<a class="reference external" href="https://docs.julialang.org/en/v1/stdlib/Distributed/#Distributed.pmap"><strong><code class="docutils literal notranslate"><span class="pre">pmap</span></code></strong></a>)</p></li>
</ul>
<section id="distributed-loops-distributed">
<h4>Distributed loops (<code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code>)<a class="headerlink" href="#distributed-loops-distributed" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Distributed</span><span class="p">,</span><span class="w"> </span><span class="n">BenchmarkTools</span><span class="p">;</span>
<span class="n">rmprocs</span><span class="p">(</span><span class="n">workers</span><span class="p">());</span>
<span class="n">addprocs</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">nworkers</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-reduction">
<h4>Example: Reduction<a class="headerlink" href="#example-reduction" title="Permalink to this headline">#</a></h4>
<p>Task: Counting heads in a series of coin tosses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">count_heads_loop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">n</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="kt">Bool</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c</span>
<span class="k">end</span>

<span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200_000_000</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">count_heads_loop</span><span class="p">(</span><span class="o">$</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  280.192 ms (0 allocations: 0 bytes)
</pre></div>
</div>
</div>
</div>
<p>Note that these kinds of computations are called <strong>reductions</strong> (with <code class="docutils literal notranslate"><span class="pre">+</span></code> being the <strong>reducer function</strong>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">count_heads_reduce</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapreduce</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="kt">Bool</span><span class="p">),</span><span class="w"> </span><span class="o">+</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="p">)</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">count_heads_reduce</span><span class="p">(</span><span class="o">$</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  283.877 ms (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>99996450
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">count_heads_distributed_loop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@distributed</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">n</span>
<span class="w">        </span><span class="kt">Int</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="kt">Bool</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count_heads_distributed_loop (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">count_heads_distributed_loop</span><span class="p">(</span><span class="o">$</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  70.094 ms (304 allocations: 12.73 KiB)
</pre></div>
</div>
</div>
</div>
<p>The distributed version is about <strong>4x faster</strong>, which is all we could hope for.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code> the work is <strong>evenly distributed</strong> between the workers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">count_heads_distributed_verbose</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@distributed</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">n</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Int</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="kt">Bool</span><span class="p">))</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="n">x</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">c</span>
<span class="k">end</span>

<span class="n">count_heads_distributed_verbose</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 17:	1
      From worker 17:	1
      From worker 14:	0
      From worker 14:	1
      From worker 15:	1
      From worker 15:	0
      From worker 16:	1
      From worker 16:	0
</pre></div>
</div>
</div>
</div>
<p>However, by using <code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code> we let Julia decide how to split up the work and can’t control it ourselves.</p>
</section>
<section id="a-common-mistake">
<h4>A common mistake<a class="headerlink" href="#a-common-mistake" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nd">@distributed</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">n</span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">a</span>
<span class="k">end</span>

<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>What do you expect the value of <code class="docutils literal notranslate"><span class="pre">a</span></code> to be?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-sharedarrays">
<h4>Example: <code class="docutils literal notranslate"><span class="pre">SharedArray</span></code>s<a class="headerlink" href="#example-sharedarrays" title="Permalink to this headline">#</a></h4>
<p>Apart from <code class="docutils literal notranslate"><span class="pre">&#64;distributed</span> <span class="pre">(reducer)</span> <span class="pre">...</span></code> there also is a <code class="docutils literal notranslate"><span class="pre">&#64;distributed</span> <span class="pre">for</span> <span class="pre">...</span></code> form. The latter is <strong>non-blocking</strong> and returns a <code class="docutils literal notranslate"><span class="pre">Task</span></code>. (You can think of it as a distributed version of <code class="docutils literal notranslate"><span class="pre">&#64;spawn</span></code> for all the iterations.)</p>
<p>However, since the loop body will be executed on different processes, one must be careful to operate on data structures that are available on all processes (similar to the mistake highlighted above).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">square_broken</span><span class="p">()</span>
<span class="w">    </span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@sync</span><span class="w"> </span><span class="nd">@distributed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="w">        </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">A</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>square_broken (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">square_broken</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10-element Vector{Int64}:
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
</pre></div>
</div>
</div>
</div>
<p>To actually make all processes operate on the same array, one can use a <code class="docutils literal notranslate"><span class="pre">SharedArray</span></code>. For this to work, the <strong>processes need to live on the same host</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@everywhere</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">SharedArrays</span><span class="w"> </span><span class="c"># must be loaded everywhere</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3×2 Matrix{Float64}:
 0.146603  0.59987
 0.589621  0.20356
 0.532553  0.48248
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SharedArray</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3×2 SharedMatrix{Float64}:
 0.146603  0.59987
 0.589621  0.20356
 0.532553  0.48248
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">square!</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span><span class="w"> </span><span class="c"># mimicing some computational cost</span>
<span class="w">        </span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">square_distributed!</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@sync</span><span class="w"> </span><span class="nd">@distributed</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span><span class="w"> </span><span class="c"># mimicing some computational cost</span>
<span class="w">        </span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SharedArray</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

<span class="nd">@btime</span><span class="w"> </span><span class="n">square!</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">square_distributed!</span><span class="p">(</span><span class="o">$</span><span class="n">S</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  205.747 ms (508 allocations: 15.84 KiB)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  51.967 ms (553 allocations: 25.50 KiB)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="parallel-map-pmap">
<h3>Parallel map: <code class="docutils literal notranslate"><span class="pre">pmap</span></code><a class="headerlink" href="#parallel-map-pmap" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">square!</span></code> functions above are typical <code class="docutils literal notranslate"><span class="pre">map</span></code> operations where a function <code class="docutils literal notranslate"><span class="pre">f</span></code> is applied to all elements of a collection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">^</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10-element Vector{Int64}:
   1
   4
   9
  16
  25
  36
  49
  64
  81
 100
</pre></div>
</div>
</div>
</div>
<p>Such a pattern can be parallelized in Julia via the high-level function <code class="docutils literal notranslate"><span class="pre">pmap</span></code> (“parallel map”).</p>
<section id="example-singular-values-of-multiple-matrices">
<h4>Example: Singular values of multiple matrices<a class="headerlink" href="#example-singular-values-of-multiple-matrices" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Distributed</span><span class="p">,</span><span class="w"> </span><span class="n">BenchmarkTools</span><span class="p">;</span>
<span class="n">rmprocs</span><span class="p">(</span><span class="n">workers</span><span class="p">());</span>
<span class="n">addprocs</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">nworkers</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@everywhere</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">LinearAlgebra</span>

<span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}[</span><span class="n">rand</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">];</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">svdvals</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2-element Vector{Float64}:
 1.3697559097853798
 0.06949018191675675
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">map</span><span class="p">(</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10-element Vector{Vector{Float64}}:
 [99.73086866047831, 8.006494012777615, 7.80280631844283, 7.73013273547005, 7.688827359328027, 7.510926260582255, 7.458763568523861, 7.342220569654858, 7.322821349927925, 7.23268041904481  …  0.28921220522089097, 0.258446655889378, 0.23422634539056514, 0.20901047365246622, 0.1710187829203117, 0.15558258122689264, 0.11671434601917557, 0.09184892925328958, 0.03450869618903464, 0.007063500282456859]
 [100.4072067059727, 7.873803507225291, 7.812079192131017, 7.640036911390461, 7.59455083816383, 7.533999726866643, 7.4263900092954325, 7.313809341064693, 7.267713419957102, 7.220359811126601  …  0.3145520529945172, 0.25775980366875995, 0.2524729578091615, 0.2042630347019202, 0.17709390957703058, 0.14379789024275233, 0.11264885644632634, 0.09341683916101222, 0.058796962306847535, 0.011115062262195748]
 [100.10165842147674, 7.997550185302948, 7.876779119269794, 7.715199698730925, 7.698905582969603, 7.643683776708995, 7.497884714524174, 7.38274096578436, 7.353430551682968, 7.294799606662785  …  0.29607007328458684, 0.2736303650760007, 0.2493587640966151, 0.21937098050144951, 0.1644279363152109, 0.11526951350880556, 0.09387482232825559, 0.07689826730051547, 0.054061487866513804, 0.018553917687470566]
 [100.37124148920924, 8.025027179646909, 7.865645852200284, 7.723569952304819, 7.624042636431429, 7.553109046572213, 7.492151110449945, 7.376743653478064, 7.284560011176402, 7.240181499779993  …  0.29920139236638493, 0.2645543961011256, 0.23608287275794043, 0.20434147940884262, 0.16378383234722552, 0.13622650613842174, 0.11098004939879781, 0.09729686730243593, 0.03301217384954272, 0.002194693486613184]
 [100.16127113868536, 7.944353490375967, 7.853646591796325, 7.717921608279392, 7.681581042994799, 7.556875257725749, 7.473744455664561, 7.456746069213021, 7.348541228110086, 7.291015065858264  …  0.33107821966977047, 0.30451572817465794, 0.2986753004182599, 0.17205874855872477, 0.1519375162162515, 0.12338073632495997, 0.09566376987907477, 0.04696324648667426, 0.012009929541205696, 0.0019122043740948547]
 [100.0893803657596, 7.988601155259984, 7.95747433266235, 7.8058352827469095, 7.662661214346459, 7.600138770796575, 7.528528939763223, 7.42131498487894, 7.3704465020528795, 7.258538697072902  …  0.2959633121192713, 0.28350802560134397, 0.25962521034079683, 0.20576336472247173, 0.1913387078369644, 0.16297852808333876, 0.11868506717408935, 0.08757149718307208, 0.025548573641975027, 0.008513607597925677]
 [100.39653215386699, 8.126419467285213, 7.829429344108988, 7.6560257153453515, 7.614028653230731, 7.549422304528041, 7.486676190876436, 7.387057533358343, 7.299589976140213, 7.294657510482864  …  0.2877854583296931, 0.23973929324030271, 0.21502658689538875, 0.19136552984127464, 0.16017633373594722, 0.09616606374299849, 0.0894602813911675, 0.08129766131654474, 0.034856605140196555, 0.004982130154472452]
 [99.81925402902732, 7.96478900812593, 7.770169524085382, 7.690422446567118, 7.642094890507292, 7.573566212208979, 7.483094522739874, 7.363065201642056, 7.314486075037353, 7.226499996485138  …  0.3096451417378723, 0.25830309781035193, 0.23957273238957508, 0.1940166630484725, 0.15753784789647116, 0.14205225558929044, 0.11202456921500115, 0.06721301720176819, 0.02401700078980743, 0.010015549157209192]
 [100.6720648857603, 8.05875563239604, 7.944461388459882, 7.799616109232079, 7.710031554555538, 7.616160515985552, 7.470309881320852, 7.3603438630220435, 7.251280280384302, 7.211051207883165  …  0.3117465039496361, 0.2948515083607065, 0.2558518783048727, 0.22213794234629483, 0.19495625354389876, 0.1381983822206344, 0.10909444159718926, 0.09574459076696458, 0.038487643048272055, 0.028547111634317102]
 [100.54638542112743, 7.97896538374575, 7.854050862904659, 7.750064060155789, 7.6835276803092745, 7.614694807407605, 7.533511421510273, 7.447548588001529, 7.351899249324389, 7.25349322648874  …  0.3322254914716429, 0.2881853442326379, 0.24547887094216117, 0.21844270609761296, 0.2037903402588457, 0.15379028707377704, 0.09194334812612034, 0.06592840817024527, 0.0528036930060687, 0.0010404121072424965]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">pmap</span><span class="p">(</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10-element Vector{Vector{Float64}}:
 [99.73086866047831, 8.006494012777617, 7.802806318442831, 7.730132735470041, 7.688827359328022, 7.510926260582254, 7.458763568523868, 7.342220569654859, 7.322821349927925, 7.232680419044815  …  0.2892122052208916, 0.2584466558893776, 0.2342263453905652, 0.20901047365246714, 0.171018782920311, 0.1555825812268926, 0.1167143460191755, 0.09184892925329, 0.03450869618903406, 0.007063500282457334]
 [100.4072067059727, 7.873803507225294, 7.812079192131006, 7.640036911390455, 7.594550838163836, 7.5339997268666385, 7.426390009295433, 7.3138093410647, 7.267713419957102, 7.220359811126602  …  0.314552052994517, 0.25775980366875945, 0.25247295780916196, 0.2042630347019207, 0.17709390957703017, 0.143797890242752, 0.11264885644632552, 0.09341683916101261, 0.058796962306847354, 0.011115062262195705]
 [100.10165842147674, 7.997550185302943, 7.876779119269788, 7.715199698730935, 7.6989055829696005, 7.643683776709006, 7.497884714524183, 7.382740965784361, 7.353430551682968, 7.29479960666279  …  0.2960700732845874, 0.2736303650760004, 0.249358764096615, 0.21937098050144951, 0.1644279363152114, 0.11526951350880671, 0.0938748223282552, 0.07689826730051566, 0.05406148786651307, 0.018553917687471506]
 [100.37124148920924, 8.02502717964691, 7.865645852200288, 7.723569952304823, 7.624042636431442, 7.553109046572226, 7.492151110449956, 7.376743653478068, 7.284560011176413, 7.240181499779996  …  0.299201392366385, 0.264554396101125, 0.2360828727579408, 0.2043414794088412, 0.16378383234722482, 0.13622650613842127, 0.1109800493987985, 0.09729686730243543, 0.03301217384954288, 0.002194693486613815]
 [100.16127113868536, 7.944353490375973, 7.8536465917963225, 7.717921608279388, 7.681581042994796, 7.5568752577257445, 7.473744455664558, 7.456746069213029, 7.3485412281100855, 7.291015065858263  …  0.3310782196697711, 0.30451572817465805, 0.2986753004182599, 0.17205874855872538, 0.15193751621625118, 0.12338073632496041, 0.09566376987907477, 0.04696324648667364, 0.012009929541206494, 0.0019122043740951332]
 [100.0893803657596, 7.988601155259996, 7.957474332662345, 7.8058352827469015, 7.662661214346453, 7.600138770796577, 7.52852893976322, 7.421314984878935, 7.370446502052886, 7.258538697072895  …  0.2959633121192718, 0.2835080256013436, 0.25962521034079683, 0.2057633647224712, 0.1913387078369639, 0.16297852808333904, 0.11868506717408932, 0.0875714971830724, 0.025548573641974725, 0.00851360759792604]
 [100.39653215386699, 8.126419467285215, 7.829429344108986, 7.656025715345354, 7.614028653230737, 7.549422304528047, 7.486676190876431, 7.387057533358343, 7.299589976140224, 7.2946575104828755  …  0.28778545832969255, 0.23973929324030263, 0.21502658689538798, 0.1913655298412751, 0.16017633373594742, 0.09616606374299849, 0.08946028139116712, 0.08129766131654466, 0.03485660514019734, 0.004982130154473484]
 [99.81925402902732, 7.964789008125931, 7.770169524085382, 7.690422446567124, 7.642094890507294, 7.573566212208985, 7.483094522739874, 7.36306520164205, 7.314486075037343, 7.226499996485139  …  0.30964514173787183, 0.25830309781035093, 0.23957273238957488, 0.1940166630484721, 0.15753784789647118, 0.1420522555892906, 0.11202456921500152, 0.06721301720176846, 0.024017000789806463, 0.010015549157208368]
 [100.6720648857603, 8.058755632396046, 7.944461388459885, 7.799616109232085, 7.71003155455554, 7.616160515985561, 7.470309881320866, 7.360343863022057, 7.2512802803843055, 7.2110512078831634  …  0.3117465039496366, 0.2948515083607064, 0.255851878304873, 0.22213794234629491, 0.1949562535438985, 0.13819838222063352, 0.10909444159719028, 0.09574459076696375, 0.03848764304827188, 0.028547111634316228]
 [100.54638542112743, 7.978965383745747, 7.854050862904653, 7.750064060155779, 7.683527680309263, 7.614694807407601, 7.533511421510266, 7.44754858800153, 7.351899249324379, 7.253493226488741  …  0.3322254914716426, 0.28818534423263736, 0.24547887094216084, 0.21844270609761324, 0.2037903402588461, 0.15379028707377704, 0.09194334812612057, 0.06592840817024584, 0.05280369300606897, 0.0010404121072420428]
</pre></div>
</div>
</div>
</div>
<p>Let’s check that this indeed utilized multiple workers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">pmap</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="n">m</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">myid</span><span class="p">())</span>
<span class="w">    </span><span class="n">svdvals</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">end</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 19:	19
      From worker 18:	18
      From worker 19:	19
      From worker 18:	18
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 20:	20
      From worker 21:	21
      From worker 21:	21
      From worker 19:	19
      From worker 18:	18
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 20:	20
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="o">$</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">M</span><span class="p">);</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">pmap</span><span class="p">(</span><span class="o">$</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">M</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  62.533 ms (81 allocations: 4.22 MiB)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  15.221 ms (512 allocations: 36.97 KiB)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="when-to-choose-which-distributed-vs-pmap">
<h3>When to choose which? (<code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code> vs <code class="docutils literal notranslate"><span class="pre">pmap</span></code>)<a class="headerlink" href="#when-to-choose-which-distributed-vs-pmap" title="Permalink to this headline">#</a></h3>
<p>Julia’s <code class="docutils literal notranslate"><span class="pre">pmap</span></code> is designed for the case where</p>
<ul class="simple">
<li><p>one wants to apply <strong>a function to a collection</strong>,</p></li>
<li><p>each function call does a <strong>larger amount of work</strong>, and/or</p></li>
<li><p>the <strong>workload is non-uniform</strong> (load-balancing).</p></li>
</ul>
<p>On the other hand, <code class="docutils literal notranslate"><span class="pre">&#64;distributed</span></code> is good for</p>
<ul class="simple">
<li><p><strong>reductions</strong>, like sums, where</p></li>
<li><p><strong>each iteration may be tiny</strong>, i.e. perhaps only summing two numbers, and/or</p></li>
<li><p>each iteration <strong>takes about the same time</strong> (uniform)</p></li>
</ul>
</section>
</section>
<section id="high-level-array-abstractions-distributedarrays-jl">
<h2>High-level array abstractions: <a class="reference external" href="https://github.com/JuliaParallel/DistributedArrays.jl">DistributedArrays.jl</a><a class="headerlink" href="#high-level-array-abstractions-distributedarrays-jl" title="Permalink to this headline">#</a></h2>
<p>In a <code class="docutils literal notranslate"><span class="pre">DArray</span></code>, each process has local access to just a chunk of the data, and no two processes share the same chunk. Processes can be on different hosts.</p>
<p>Distributed arrays are for example useful if</p>
<ul class="simple">
<li><p>Expensive calculations should be performed in parallel on parts of the array on different hosts.</p></li>
<li><p>The data doesn’t fit into the local machines memory (i.e. loading big files in parallel).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Distributed</span><span class="p">,</span><span class="w"> </span><span class="n">BenchmarkTools</span><span class="p">;</span>
<span class="n">rmprocs</span><span class="p">(</span><span class="n">workers</span><span class="p">());</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># make sure that all workers use the same Julia environment</span>
<span class="n">addprocs</span><span class="p">(</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">exeflags</span><span class="o">=</span><span class="s">&quot;--project&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 22
 23
 24
 25
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># check</span>
<span class="nd">@everywhere</span><span class="w"> </span><span class="nd">@show</span><span class="w"> </span><span class="n">Base</span><span class="o">.</span><span class="n">active_project</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Base.active_project() = &quot;/__w/julia-hpc-workshop/julia-hpc-workshop/Project.toml&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      From worker 22:	Base.active_project() = &quot;/__w/julia-hpc-workshop/julia-hpc-workshop/Project.toml&quot;
      From worker 25:	Base.active_project() = &quot;/__w/julia-hpc-workshop/julia-hpc-workshop/Project.toml&quot;
      From worker 24:	Base.active_project() = &quot;/__w/julia-hpc-workshop/julia-hpc-workshop/Project.toml&quot;
      From worker 23:	Base.active_project() = &quot;/__w/julia-hpc-workshop/julia-hpc-workshop/Project.toml&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@everywhere</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">DistributedArrays</span><span class="p">,</span><span class="w"> </span><span class="n">LinearAlgebra</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Matrix</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}[</span><span class="n">rand</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">10</span><span class="p">];</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distribute</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10-element DArray{Matrix{Float64}, 1, Vector{Matrix{Float64}}}:
 [0.8651036495669074 0.5600375135012516 … 0.11367345624350633 0.18121807996498662; 0.5542138829763541 0.46644749306690225 … 0.386859636748471 0.2029368629427306; … ; 0.9937373619491334 0.8083549858232936 … 0.6116505425826603 0.5182736757752832; 0.37868119094213937 0.8191133498855974 … 0.03824014832134126 0.9647968284829839]
 [0.7690522379951574 0.19721911314967022 … 0.6870279370678357 0.31135013826624114; 0.5718597950725197 0.5949489374390478 … 0.31002957095880324 0.48889031586037945; … ; 0.9011472169536924 0.4321959785312949 … 0.4844159886794629 0.22085848854504764; 0.13625371349736737 0.05078695081496809 … 0.03973507876563653 0.8177199888754829]
 [0.6034439718043699 0.6084599238990059 … 0.4770737479750664 0.1629499600824481; 0.29930675761623526 0.2662212126371445 … 0.3443998500067842 0.5947036035623405; … ; 0.09595229638592884 0.12903851823698764 … 0.8735349246173806 0.9146064926726227; 0.4448437049090165 0.06897574465839407 … 0.8174630960452696 0.21966305078977277]
 [0.27614523009152225 0.499061226609226 … 0.9696609320898566 0.008624966438581905; 0.11638821052586701 0.9644842722718934 … 0.9519238127872265 0.5558618339000542; … ; 0.23704406173928838 0.48118467171660384 … 0.3997824472592797 0.4722293890388345; 0.16599129917025335 0.7960430206807046 … 0.477088712194614 0.16289962929557078]
 [0.7343036888789476 0.9866073111168323 … 0.7178495548689919 0.9153675417611055; 0.07717742077898404 0.9461527440432084 … 0.29629345091064696 0.2698007509468012; … ; 0.16114156632345 0.26601001582071104 … 0.6492307081002439 0.07515103677081525; 0.5204284251342688 0.167129999456765 … 0.7643699571035611 0.26891781354747946]
 [0.22485578738592316 0.30357135958488257 … 0.8164979727649785 0.7468154880770094; 0.19659198193010174 0.6074098632804337 … 0.7952055692457966 0.5286358237435881; … ; 0.38750734179356594 0.7629717401630519 … 0.08781527841006209 0.5347599509150344; 0.03452867290733008 0.25994002403763417 … 0.8637563120099156 0.2826457316232418]
 [0.13444067095592993 0.4256645848448144 … 0.016699838889410623 0.06453722043047494; 0.9696081261446701 0.5864755998238093 … 0.4295856319897662 0.726743046766809; … ; 0.8456863829250172 0.12754463798495552 … 0.7099834616254914 0.9229899989905208; 0.24950980685106172 0.5771312862296839 … 0.14805776935862747 0.7107784344774352]
 [0.058891344054504025 0.008851017511644077 … 0.7529915887402863 0.3726767550446902; 0.5924872020680282 0.14925470174634325 … 0.08244871133288789 0.9454996258638187; … ; 0.08594595826720608 0.9543469174653347 … 0.657501709660043 0.7634388562866837; 0.0836898721882583 0.1001194127988414 … 0.4458847311602264 0.6226580717494937]
 [0.590234469418541 0.24322286789487912 … 0.0642677166699942 0.3276750436731083; 0.2887029604288577 0.8034437503196653 … 0.3620515228921093 0.8852124284903048; … ; 0.36306157261683614 0.8443535946915673 … 0.21592300572421053 0.049048935299121355; 0.8796029624635217 0.7482532140011545 … 0.9911923117748069 0.9667252512343909]
 [0.34571867835257664 0.4023335724574544 … 0.9643258774105321 0.9507467559552676; 0.6504099117601733 0.9598570213073842 … 0.01126251749986007 0.02788428468057591; … ; 0.11448969673307208 0.47085104201506134 … 0.5405188435682969 0.20080267937668705; 0.2671697790623918 0.48776581517282236 … 0.30449104026167595 0.5755685816092713]
</pre></div>
</div>
</div>
</div>
<p>Which workers hold parts of D?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">procs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 22
 23
 24
 25
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">workers</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4-element Vector{Int64}:
 22
 23
 24
 25
</pre></div>
</div>
</div>
</div>
<p>Which parts do they hold?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">localpart</span><span class="p">(</span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="c"># the controller doesn&#39;t hold anything</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matrix{Float64}[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Which parts do they hold?</span>
<span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">workers</span><span class="p">()</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="nd">@fetchfrom</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">DistributedArrays</span><span class="o">.</span><span class="n">localindices</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1:3,)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(4:6,)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(7:8,)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(9:10,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="o">$</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">M</span><span class="p">);</span>
<span class="nd">@btime</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="o">$</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">D</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  62.659 ms (81 allocations: 4.22 MiB)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  14.823 ms (553 allocations: 25.67 KiB)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span><span class="w"> </span><span class="n">pmap</span><span class="p">(</span><span class="o">$</span><span class="n">svdvals</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">M</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  15.212 ms (511 allocations: 36.94 KiB)
</pre></div>
</div>
</div>
</div>
</section>
<section id="actual-distributed-computing-comments">
<h2><em>Actual</em> distributed computing: Comments<a class="headerlink" href="#actual-distributed-computing-comments" title="Permalink to this headline">#</a></h2>
<section id="creating-workers-on-other-machines">
<h3>Creating workers on other machines<a class="headerlink" href="#creating-workers-on-other-machines" title="Permalink to this headline">#</a></h3>
<p>So far we have worked with multiple process on the same system, because we simply used <code class="docutils literal notranslate"><span class="pre">addprocs(::Integer)</span></code>. To put worker processes on other machines, e.g. nodes of a cluster, we need to modify the initial <code class="docutils literal notranslate"><span class="pre">addprocs</span></code> call appropriately.</p>
<p>In Julia, starting worker processes is handled by <a class="reference external" href="https://docs.julialang.org/en/v1/manual/distributed-computing/#ClusterManagers">ClusterManagers</a>.</p>
<ul class="simple">
<li><p>The default one is <code class="docutils literal notranslate"><span class="pre">LocalManager</span></code>. It is automatically used when running <code class="docutils literal notranslate"><span class="pre">addprocs(i::Integer)</span></code> and we have implicitly used it already.</p></li>
<li><p>Another important one is <code class="docutils literal notranslate"><span class="pre">SSHManager</span></code>. It is automatically used when running <code class="docutils literal notranslate"><span class="pre">addprocs(hostnames::Array)</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">addprocs([&quot;node123&quot;,</span> <span class="pre">&quot;node456&quot;])</span></code>. The only requirement is a <strong>passwordless ssh access</strong> to all specified hosts.</p></li>
<li><p>Cluster managers for SLURM, PBS, and others are provided in <a class="reference external" href="https://github.com/JuliaParallel/ClusterManagers.jl">ClusterManagers.jl</a>. For SLURM, this will make <code class="docutils literal notranslate"><span class="pre">addprocs</span></code> use <code class="docutils literal notranslate"><span class="pre">srun</span></code> under the hood.</p></li>
</ul>
<p><em>Demonstrate in terminal from thp node</em></p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Distributed</span>

<span class="n">addprocs</span><span class="p">([</span><span class="s">&quot;l93&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;l94&quot;</span><span class="p">])</span>

<span class="nd">@everywhere</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="n">gethostname</span><span class="p">())</span>
</pre></div>
</div>
<p>One can also start multiple processes on different machines:</p>
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">addprocs</span><span class="p">([(</span><span class="s">&quot;node123&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;node456&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)])</span><span class="w"> </span><span class="c"># starts 2 workers on node123 and 3 workers on node456</span>

<span class="c"># Use :auto to start as many processes as CPU threads are available</span>
</pre></div>
</div>
<p><strong>Be aware of different paths:</strong></p>
<ul class="simple">
<li><p>By default, <code class="docutils literal notranslate"><span class="pre">addprocs</span></code> expects to find the julia executable on the remote machines under the same path as on the host (controller).</p></li>
<li><p>It will also try to <code class="docutils literal notranslate"><span class="pre">cd</span></code> to the same folder (set the working directory).</p></li>
</ul>
<p>As you can see from <code class="docutils literal notranslate"><span class="pre">?addprocs</span></code>, <code class="docutils literal notranslate"><span class="pre">addprocs</span></code> takes a bunch of keyword arguments, two of which are of particular importance in this regard:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dir</span></code>: working directory for the worker processes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exename</span></code>: path to julia executable (potentially augmented with pre-commands) for the worker processes</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># cleanup</span>
<span class="n">rmprocs</span><span class="p">(</span><span class="n">workers</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Task (done) @0x00007fd3927a55a0
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.8"
        },
        kernelOptions: {
            kernelName: "julia-1.8",
            path: "./sessions/3-parallel"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.8'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="1-parallelism-concurrency.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Parallel Computing</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="3-distributed-computing-mpi.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Distributed Computing: Message Passing Interface (MPI)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Robert Rosca<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>